(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["Chart"],{"024c":function(e,t,i){"use strict";var s=i("9ab4"),a=i("2b0e"),n=i("2fe1");let r=class extends a["default"]{get pane(){return this.$store.state.panes.panes[this.paneId]}mounted(){this.$el.id=this.paneId,this.refreshZoom(),this.$nextTick(()=>{const e=this.$el.clientWidth;"function"===typeof this.onResize&&this.onResize(e,this.$el.clientHeight,!0)}),this.$el.addEventListener("mousedown",this.focusPane)}beforeDestroy(){this.$el.removeEventListener("mousedown",this.focusPane),this._onStoreMutation&&this._onStoreMutation()}refreshZoom(){this.$store.dispatch("panes/refreshZoom",{id:this.paneId})}focusPane(){this.$store.commit("app/SET_FOCUSED_PANE",this.paneId)}};r=Object(s["a"])([Object(n["b"])({props:{paneId:{required:!0,type:String}}})],r),t["a"]=r},1748:function(e,t,i){},3285:function(e,t,i){"use strict";i("91a7")},"61d5":function(e,t,i){},7042:function(e,t,i){"use strict";var s=function(){var e=this,t=e._self._c;e._self._setupProxy;return t("div",{staticClass:"alerts-list hide-scrollbar",class:[e.withOptions&&"alerts-list--with-options"]},[e.withOptions?t("div",{staticClass:"alert-list__header dropdown-item"},[t("label",{staticClass:"checkbox-control -small w-100",on:{click:function(e){e.stopPropagation()},mousedown:function(e){e.preventDefault()}}},[t("input",{staticClass:"form-control",attrs:{type:"checkbox"},domProps:{checked:e.alertsClick},on:{change:function(t){return e.$store.commit("settings/TOGGLE_ALERTS_CLICK")}}}),t("span",[e._v("1 click")]),t("i",{directives:[{name:"tippy",rawName:"v-tippy"}],staticClass:"icon-info text-muted ml8",attrs:{title:"Place alerts faster ⚡️"}}),t("div",{staticClass:"mlauto"})])]):e._e(),e.filteredIndexes.length||e.isLoading?e._e():t("div",{staticClass:"alerts-list__empty px8 text-danger"},[t("i",{staticClass:"icon-cross -small"}),e._v(" no alerts "),e.query?[e._v(' matching "'+e._s(e.query)+'" ')]:e._e()],2),e._l(e.filteredIndexes,(function(i,s){return t("ToggableSection",{key:i.market,staticClass:"alerts-list__section",attrs:{model:e.sections,id:e.persistSections&&"alerts-"+i.market,"auto-close":"",small:""},scopedSlots:e._u([{key:"title",fn:function(){return[t("div",{directives:[{name:"draggable-market",rawName:"v-draggable-market"}],staticClass:"toggable-section__title",attrs:{"data-market":i.market}},[e._v(" "+e._s(i.market)+" "),i.alerts.length>1?t("span",{staticClass:"badge -invert ml8"},[e._v(e._s(i.alerts.length))]):e._e()])]},proxy:!0},{key:"control",fn:function(){return[t("Btn",{ref:"clearBtns",refInFor:!0,staticClass:"-text mr16",on:{click:function(t){return e.clearAlerts(i,e.$refs.clearBtns[s])}}},[t("i",{staticClass:"icon-trash"})])]},proxy:!0}],null,!0)},[i.alerts.length?t("table",{staticClass:"table alerts-list__table"},[t("tbody",e._l(i.alerts,(function(i){return t("tr",{key:i.id,staticClass:"alerts-list-item",class:[i.triggered&&"alerts-list-item--triggered"]},[t("td",{staticClass:"table-input alerts-list-item__price"},[i.message?t("span",{directives:[{name:"tippy",rawName:"v-tippy",value:{followCursor:!0,distance:24},expression:"{ followCursor: true, distance: 24 }"}],attrs:{title:i.message}},[e._v(" "+e._s(e.formatPrice(i.price,i.market))+" ")]):t("span",[e._v(" "+e._s(e.formatPrice(i.price,i.market))+" ")])]),t("td",{staticClass:"alerts-list-item__status table-input text-nowrap text-right",class:[i.triggered&&"text-success"]},[i.triggered?[t("i",{staticClass:"icon-check"}),e._v(" Triggered ")]:i.active?[e._v("Active")]:[e._v("Inactive")]],2),i.triggered?t("td",{staticClass:"table-action -hover",on:{click:function(t){return t.stopPropagation(),e.removeAlert(i)}}},[t("button",{staticClass:"btn -text -small"},[t("i",{staticClass:"icon-cross"})])]):t("td",{staticClass:"table-action -hover",on:{click:function(t){return t.stopPropagation(),e.togglePresetDropdown(t,i)}}},[t("button",{staticClass:"btn -text -small"},[t("i",{staticClass:"icon-more"})])])])})),0)]):t("p",{staticClass:"text-danger pl8"},[e._v("No alerts")])])})),t("dropdown",{model:{value:e.alertDropdownTrigger,callback:function(t){e.alertDropdownTrigger=t},expression:"alertDropdownTrigger"}},[e.dropdownAlert&&!e.dropdownAlert.triggered?[t("Btn",{staticClass:"dropdown-item -cases",attrs:{type:"button",loading:e.isLoading},on:{click:function(t){t.stopPropagation(),e.checkStatus(e.dropdownAlert).then(()=>e.alertDropdownTrigger=null)}}},[t("i",{staticClass:"icon-search"}),t("span",[e._v("Check status")])]),t("div",{staticClass:"dropdown-divider"})]:e._e(),t("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:function(t){return e.removeAlert(e.dropdownAlert)}}},[t("i",{staticClass:"icon-cross"}),t("span",[e._v("Remove")])])],2)],2)},a=[],n=i("9ab4"),r=i("60a3"),o=i("ec0e"),c=i("be31"),l=i("017a"),h=i("f634"),d=i("0c01"),p=i("a914"),u=i("28f3"),m=i("06c2");let g=class extends r["c"]{constructor(){super(...arguments),this.dropdownAlert=null,this.alertDropdownTrigger=null,this.indexes=[],this.sections=[],this.isLoading=!1}get queryFilter(){return new RegExp(this.query,"i")}get alertsClick(){return this.$store.state.settings.alertsClick}get filteredIndexes(){return this.query?this.indexes.filter(e=>this.queryFilter.test(e.market)):this.indexes}async created(){if(await this.getAlerts(),1===this.filteredIndexes.length){const e="alerts-"+this.filteredIndexes[0].market;-1===this.$store.state.settings.sections.indexOf(e)&&this.$store.commit("settings/TOGGLE_SECTION",e)}p["a"].on("alert",this.onAlert)}beforeDestroy(){p["a"].off("alert",this.onAlert)}async getAlerts(){this.isLoading=!0;const e=await c["a"].getAllAlerts();for(let t=0;t<e.length;t++)this.$set(this.indexes,t,e[t]);await Object(u["y"])(100),this.isLoading=!1}formatPrice(e,t){return Object(m["d"])(e,t)}togglePresetDropdown(e,t){this.alertDropdownTrigger?this.alertDropdownTrigger=null:(this.alertDropdownTrigger=e.currentTarget,this.dropdownAlert=t)}async removeAlert(e){this.isLoading=!0,await h["b"].removeAlert(e),this.isLoading=!1}async createAlert(e){this.isLoading=!0,await h["b"].createAlert(e),this.isLoading=!1}async checkStatus(e){this.isLoading=!0;const t=await h["b"].toggleAlert(e.market,e.price,void 0,void 0,!0);if(this.isLoading=!1,t.alert)d["a"].confirm({message:`Alert ${e.market} @<code>${e.price}</code> is still pending`,html:!0,ok:"Ok",cancel:null});else{const t=await d["a"].confirm({title:"Not found",message:"Alert already triggered or expired",html:!0,ok:"Recreate",actions:[{label:"Remove",callback:()=>2}]});t?2===t?this.removeAlert(e):this.createAlert(e):await h["b"].deactivateAlert(e)}}onAlert({price:e,market:t,type:i,newPrice:s,message:a}){let n=this.indexes.find(e=>e.market===t);if(!n){if(i!==h["a"].CREATED)return;this.$set(this.indexes,this.indexes.length,{market:t,alerts:[]}),n=this.indexes[this.indexes.length-1],-1===this.sections.indexOf("alerts-"+this.sections)&&this.sections.push("alerts-"+this.sections)}const r=n.alerts.findIndex(t=>t.price===e);-1!==r?i===h["a"].DELETED?(n.alerts.splice(r,1),n.alerts.length||this.indexes.splice(this.indexes.indexOf(n),1)):i===h["a"].UPDATED?this.$set(n.alerts[r],"price",s):i===h["a"].TRIGGERED?this.$set(n.alerts[r],"triggered",!0):i===h["a"].ACTIVATED?(this.$set(n.alerts[r],"active",!0),"undefined"!==typeof a&&this.$set(n.alerts[r],"message",a)):i===h["a"].DEACTIVATED&&this.$set(n.alerts[r],"active",!1):i===h["a"].CREATED&&this.$set(n.alerts,n.alerts.length,{price:e,market:t})}async clearAlerts(e,t){if(!await d["a"].confirm({message:`Remove all ${e.market} alerts`,ok:`Yes (${e.alerts.length})`}))return;t&&(t.loading=!0);const i=[...e.alerts];for(const s of i)await h["b"].removeAlert(s);await c["a"].saveAlerts({market:e.market,alerts:[]}),t&&(t.loading=!1)}};g=Object(n["a"])([Object(r["a"])({components:{ToggableSection:o["a"],Btn:l["a"]},name:"Alerts",props:{query:{type:String,default:""},persistSections:{type:Boolean,default:!1},withOptions:{type:Boolean,default:!1}}})],g);var f=g,b=f,v=(i("a1a4"),i("2877")),I=Object(v["a"])(b,s,a,!1,null,"33d63b47",null);t["a"]=I.exports},"7b89":function(e,t,i){},"8c91":function(e,t,i){"use strict";var s=function(){var e=this,t=e._self._c;e._self._setupProxy;return t("div",{staticClass:"pane-header hide-scrollbar d-flex",class:[e.split&&"pane-header--split"],on:{dblclick:e.maximizePane}},[e.showName&&e.name?t("div",{staticClass:"pane-header__name pane-overlay",on:{dblclick:e.renamePane}},[e._t("title",(function(){return[e._v(" "+e._s(e.name)+" ")]}))],2):e._e(),t("div",{staticClass:"toolbar pane-overlay"},[e._t("default"),e.showSearch?t("button",{staticClass:"btn toolbar__label toolbar__label--768 -text",attrs:{type:"button"},on:{click:e.openSearch}},[t("i",{staticClass:"icon-search"})]):e._e(),e.settings?t("btn",{staticClass:"toolbar__label toolbar__label--768 -text",attrs:{type:"button",loading:e.isLoading},on:{click:e.openSettings}},[t("i",{staticClass:"icon-cog"})]):e._e(),t("button",{staticClass:"btn -text toolbar__label",attrs:{type:"button"},on:{click:e.toggleDropdown}},[t("i",{staticClass:"icon-more"})]),t("dropdown",{model:{value:e.paneDropdownTrigger,callback:function(t){e.paneDropdownTrigger=t},expression:"paneDropdownTrigger"}},[t("div",{staticClass:"d-flex btn-group"},[t("button",{staticClass:"btn -green",attrs:{type:"button"},on:{click:function(t){return t.stopPropagation(),e.changeZoom(t,-1)}}},[t("i",{staticClass:"icon-minus"})]),t("button",{staticClass:"btn -green text-monospace flex-grow-1 text-center",attrs:{type:"button"},on:{click:function(t){return t.stopPropagation(),e.resetZoom.apply(null,arguments)}}},[e._v(" × "+e._s(e.zoom.toFixed(2))+" ")]),t("button",{staticClass:"btn -green",attrs:{type:"button"},on:{click:function(t){return t.stopPropagation(),e.changeZoom(t,1)}}},[t("i",{staticClass:"icon-plus"})])]),null!==e.settings?t("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:e.openSettings}},[t("i",{staticClass:"icon-cog"}),t("span",[e._v("Settings")])]):e._e(),e.showSearch?t("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:e.openSearch}},[t("i",{staticClass:"icon-search"}),t("span",[e._v("Sources")])]):e._e(),e.$slots.menu?t("div",{staticClass:"dropdown-divider",attrs:{"data-label":e.paneId+" options"}}):e._e(),e._t("menu"),t("div",{staticClass:"dropdown-divider",attrs:{"data-label":"utilities"}}),t("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:e.maximizePane}},[t("i",{staticClass:"icon-enlarge"}),t("span",[e._v("Maximize")])]),t("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:e.duplicatePane}},[t("i",{staticClass:"icon-copy-paste"}),t("span",[e._v("Duplicate")])]),t("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:e.downloadPane}},[t("i",{staticClass:"icon-download"}),t("span",[e._v("Download")])]),t("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:e.renamePane}},[t("i",{staticClass:"icon-edit"}),t("span",[e._v("Rename")])]),t("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:e.removePane}},[t("i",{staticClass:"icon-trash"}),t("span",[e._v("Remove")])])],2)],2)])},a=[],n=i("9ab4"),r=i("2b0e"),o=i("2fe1"),c=i("017a"),l=i("28f3"),h=i("0c01");let d=class extends r["default"]{constructor(){super(...arguments),this.paneDropdownTrigger=null,this.isLoading=!1}get zoom(){return this.$store.state.panes.panes[this.paneId].zoom||1}get type(){return this.$store.state.panes.panes[this.paneId].type}get name(){const e=this.$store.state.panes.panes[this.paneId].name,t=this.$store.state.panes.marketsListeners[this.$store.state.panes.panes[this.paneId].markets[0]];return e?e.trim():t?t.local:this.type}openSearch(){this.$store.dispatch("app/showSearch",{paneId:this.paneId})}changeZoom(e,t){const i=this.zoom+(e.shiftKey?.0625:.125)*t;this.$store.dispatch("panes/setZoom",{id:this.paneId,zoom:i}),this.$emit("zoom",i)}resetZoom(){this.$store.dispatch("panes/setZoom",{id:this.paneId,zoom:1}),this.$emit("zoom",1)}async removePane(){await h["a"].confirm(`Delete pane ${this.type} "${this.name}" ?`)&&this.$store.dispatch("panes/removePane",this.paneId)}duplicatePane(){this.$store.dispatch("panes/duplicatePane",this.paneId)}maximizePane(e){if("dblclick"===e.type&&e.currentTarget!==e.target)return;const t=this.$el.parentElement.parentElement,i=t.classList.toggle("-maximized"),s=Object(l["p"])(t);for(const n of s)n.getAttribute("type")&&(n.classList.remove("-maximized"),n.style.display=i?"none":"block");const a=Event;window.dispatchEvent(new a("resize")),this.$store.dispatch("panes/refreshZoom",{id:this.paneId,zoom:i?2:this.zoom})}async renamePane(e){e&&e.stopPropagation();const t=await h["a"].prompt({action:"Rename",input:this.name});"string"===typeof t&&t!==this.name&&this.$store.commit("panes/SET_PANE_NAME",{id:this.paneId,name:t})}async downloadPane(){Object(l["g"])({name:`${this.type}:${this.paneId}`,type:this.type,data:this.$store.state[this.paneId],markets:this.$store.state.panes.panes[this.paneId].markets,createdAt:Date.now(),updatedAt:null},Object(l["z"])(this.paneId))}toggleDropdown(e){this.paneDropdownTrigger?this.paneDropdownTrigger=null:this.paneDropdownTrigger=e.currentTarget}async openSettings(){this.settings&&(this.isLoading=!0,h["a"].open((await this.settings()).default,{paneId:this.paneId}),this.isLoading=!1)}};d=Object(n["a"])([Object(o["b"])({name:"PaneHeader",props:{paneId:{type:String},settings:{type:Function,default:null},showSearch:{type:Boolean,default:!0},showName:{type:Boolean,default:!0},split:{type:Boolean,default:!0}},components:{Btn:c["a"]}})],d);var p=d,u=p,m=i("2877"),g=Object(m["a"])(u,s,a,!1,null,null,null);t["a"]=g.exports},"8fef":function(e,t,i){"use strict";i("61d5")},"91a7":function(e,t,i){},"9fed":function(e,t,i){"use strict";i("ffb1")},a1a4:function(e,t,i){"use strict";i("7b89")},aa6c:function(e,t,i){"use strict";i.r(t);var s=function(){var e=this,t=e._self._c;e._self._setupProxy;return t("div",{staticClass:"pane-chart"},[t("pane-header",{ref:"paneHeader",attrs:{paneId:e.paneId,settings:()=>i.e("chunk-fa93ecf8").then(i.bind(null,"be9d"))},scopedSlots:e._u([{key:"menu",fn:function(){return[t("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:e.toggleLayout}},[t("i",{staticClass:"icon-resize-height"}),t("span",[e._v("Arrange")])]),t("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:e.restart}},[t("i",{staticClass:"icon-refresh"}),t("span",[e._v("Restart")])]),t("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:e.takeScreenshot}},[t("i",{staticClass:"icon-add-photo"}),t("span",[e._v("Snapshot")])])]},proxy:!0}])},[e._l(e.favoriteTimeframes,(function(i,s){return t("button",{key:s,staticClass:"toolbar__label timeframe -text",attrs:{title:"Maintain shift key to change timeframe on all panes"},on:{click:function(t){return e.$store.dispatch(e.paneId+"/setTimeframe",s)}}},[t("span",[e._v(e._s(i))])])})),t("Btn",{ref:"timeframeButton",staticClass:"-arrow toolbar__label -text",on:{click:function(t){return e.toggleTimeframeDropdown(t,e.$refs.timeframeButton)}}},[e._v(" "+e._s(e.timeframeForHuman)+" ")])],2),t("div",{staticClass:"chart-overlay hide-scrollbar",style:{left:e.overlayLeft+"px"}},[t("indicators-overlay",{attrs:{"pane-id":e.paneId},model:{value:e.showIndicators,callback:function(t){e.showIndicators=t},expression:"showIndicators"}}),t("markets-overlay",{attrs:{"pane-id":e.paneId}})],1),t("div",{ref:"chartContainer",staticClass:"chart__container"},[e.layouting?t("chart-layout",{attrs:{"pane-id":e.paneId,layouting:e.layouting,axis:e.axis}}):e._e()],1)],1)},a=[],n=i("9ab4"),r=i("60a3"),o=i("0613"),c=i("9613"),l=i("28f3"),h=i("d951"),d=i("fa07"),p=i("da81"),u=i.n(p),m=i("ecab"),g=i("0c01"),f=i("a914"),b=i("be31"),v=i("06c2"),I=i("4902"),y=i("f634"),w=i("ba10"),_=i.n(w);class C extends _.a{constructor(){super(),this.promisesOfData={},this.url=Object(l["k"])("historical")}filterOutUnavailableMarkets(e){return e.filter(e=>-1!==o["b"].state.app.historicalMarkets.indexOf(e))}getApiUrl(e,t,i,s){const a=[e,t,(1e3*i).toString()];return s&&s.length&&a.push(encodeURIComponent(s.join("+"))),`${this.url}/${a.join("/")}`}fetch(e,t,i,s){const a=this.getApiUrl(e,t,i,s);return this.promisesOfData[a]||(this.promisesOfData[a]=fetch(a).then(async e=>{const t=e.headers.get("content-type");let i;if(!t||-1===t.indexOf("application/json"))throw new Error(await e.text());return i=await e.json(),i.status=e.status,i}).then(e=>{if(!e||e.error)throw new Error(e&&e.error?e.error:"empty-response");if(!e.results.length)throw new Error("No more data");if("point"!==e.format)throw new Error("Bad data");return this.normalizePoints(e.results,e.columns,i,s)}).catch(e=>{throw Object(l["r"])(e),e}).then(e=>(o["b"].commit("app/TOGGLE_LOADING",!1),delete this.promisesOfData[a],e))),this.promisesOfData[a]}normalizePoints(e,t,i,s){const a={};if(s=s.slice(),!e||!e.length)return e;let n;n=Array.isArray(e[0])?e[0][0]:+new Date(e[0].time)/1e3,s=[...s];const r={},o=Object(l["s"])(i);for(let c=0;c<e.length;c++){if(!e[c].time&&e[c][0])e[c]={time:"undefined"!==typeof t["time"]?e[c][t["time"]]:0,cbuy:"undefined"!==typeof t["cbuy"]?e[c][t["cbuy"]]:0,close:"undefined"!==typeof t["close"]?e[c][t["close"]]:0,csell:"undefined"!==typeof t["csell"]?e[c][t["csell"]]:0,high:"undefined"!==typeof t["high"]?e[c][t["high"]]:0,lbuy:"undefined"!==typeof t["lbuy"]?e[c][t["lbuy"]]:0,low:"undefined"!==typeof t["low"]?e[c][t["low"]]:0,lsell:"undefined"!==typeof t["lsell"]?e[c][t["lsell"]]:0,market:"undefined"!==typeof t["market"]?e[c][t["market"]]:0,open:"undefined"!==typeof t["open"]?e[c][t["open"]]:0,vbuy:"undefined"!==typeof t["vbuy"]?e[c][t["vbuy"]]:0,vsell:"undefined"!==typeof t["vsell"]?e[c][t["vsell"]]:0};else{if(!a[e[c].market])for(let t=c-1;t>=0;t--)if(e[t].market===e[c].market){a[e[c].market]=e[t];break}if(e[c].time=Object(l["i"])(e[c].time/1e3,i,o),!a[e[c].market]||a[e[c].market].time<e[c].time)a[e[c].market]=e[c];else if(a[e[c].market]!==e[c]){a[e[c].market].vbuy+=e[c].vbuy,a[e[c].market].vsell+=e[c].vsell,a[e[c].market].cbuy+=e[c].cbuy,a[e[c].market].csell+=e[c].csell,a[e[c].market].lbuy+=e[c].lbuy,a[e[c].market].lsell+=e[c].lsell,a[e[c].market].high=Math.max(e[c].high,a[e[c].market].high),a[e[c].market].low=Math.min(e[c].low,a[e[c].market].low),a[e[c].market].close=e[c].close,e.splice(c,1),c--;continue}}if("number"!==typeof r[e[c].market]&&(r[e[c].market]=e[c].open),e[c].time===n){const t=s.indexOf(e[c].market);s.splice(t,1)}const[h,d]=Object(v["m"])(e[c].market);e[c].exchange=h,e[c].pair=d}return{data:e,markets:s,from:e[0].time,to:e[e.length-1].time}}}var k=new C;function x(e){e.state.open=e.state.close,e.state.high=e.state.close,e.state.low=e.state.close}function S(e){e.state.point={open:e.state.open,high:e.state.high,low:e.state.low,close:e.state.close}}function O(e){e.state.open=null,e.state.high=null,e.state.low=null}function E(e){e.state.points.push(e.state.output),e.state.count++,e.state.count>e.length-1&&(e.state.points.shift(),e.state.count--)}function R(e){e.state.points.push(e.state.output),e.state.sum+=e.state.output,e.state.count++,e.state.count>e.length-1&&(e.state.sum-=e.state.points.shift(),e.state.count--)}function T(e){e.state.lows.push(e.state.low),e.state.highs.push(e.state.high),e.state.count++,e.state.count>e.length-1&&(e.state.lows.shift(),e.state.highs.shift(),e.state.count--)}var $={avg_ohlc:{state:{open:null,high:null,low:null,close:null},next:x,update(e,t){let i,s=0,a=!1,n=0,r=0,o=0;null===e.open&&(a=!0,i=0);for(const c in t.sources)t.sources[c].active&&null!==t.sources[c].open&&(a&&(i+=t.sources[c].open),n+=t.sources[c].high,r+=t.sources[c].low,o+=t.sources[c].close,s++);return s?(a&&(e.open=i/s),e.high=Math.max(e.open,n/s),e.low=Math.min(e.open,r/s),e.close=o/s,{time:t.localTimestamp,open:e.open,high:e.high,low:e.low,close:e.close}):{time:t.localTimestamp}}},heikinashi:{args:[{instruction:"renderer.localTimestamp",injected:!0}],state:{open:null,high:null,low:null,close:null},next:S,update(e,t,i){return e.high=i.high,e.low=i.low,e.open=i.open,e.close=(e.open+e.high+e.low+e.close)/4,"undefined"!==typeof e.point?e.open=(e.point.open+e.point.close)/2:e.open=(e.open+e.close)/2,e.low=Math.min(e.open,e.low,e.close),e.high=Math.max(e.open,e.high,e.close),{time:t,open:e.open,high:e.high,low:e.low,close:e.close}}},avg_heikinashi:{state:{open:null,high:null,low:null,close:null},next:S,update(e,t){let i=0;e.open=0,e.high=0,e.low=0,e.close=0;for(const s in t.sources)t.sources[s].active&&null!==t.sources[s].open&&(e.open+=t.sources[s].open,e.high+=t.sources[s].high,e.low+=t.sources[s].low,e.close+=t.sources[s].close,i++);return i||(i=1),e.high/=i,e.low/=i,e.open/=i,e.close=(e.open+e.high+e.low+e.close/i)/4,"undefined"!==typeof e.point?e.open=(e.point.open+e.point.close)/2:e.open=(e.open+e.close)/2,e.low=Math.min(e.open,e.low,e.close),e.high=Math.max(e.open,e.high,e.close),{time:t.localTimestamp,open:e.open,high:e.high,low:e.low,close:e.close}}},avg_ohlc_with_gaps:{state:{open:null,high:null,low:null,close:null},next:O,update(e,t){let i=0,s=0,a=0,n=0,r=0;for(const o in t.sources)t.sources[o].active&&null!==t.sources[o].open&&(s+=t.sources[o].open,a+=t.sources[o].high,n+=t.sources[o].low,r+=t.sources[o].close,i++);return i?(e.open=s/i,e.high=Math.max(null===e.high?-1/0:e.high,a/i),e.low=Math.min(null===e.low?1/0:e.low,n/i),e.close=r/i,{time:t.localTimestamp,open:e.open,high:e.high,low:e.low,close:e.close}):{time:t.localTimestamp}}},avg_close:{update(e,t){let i=0;e.close=0;for(const s in t.sources)t.sources[s].active&&null!==t.sources[s].open&&(e.close+=t.sources[s].close,i++);return i||(i=1),e.close/=i,e.close}},ohlc:{args:[{instruction:"renderer.localTimestamp",injected:!0}],next:x,update(e,t,i){return"undefined"===typeof e.open&&(e.open=i,e.high=i,e.low=i),e.high=Math.max(e.high,i),e.low=Math.min(e.low,i),e.close=i,{time:t,open:e.open,high:e.high,low:e.low,close:e.close}}},cum_ohlc:{args:[{instruction:"renderer.localTimestamp",injected:!0}],next:x,update(e,t,i){return"undefined"===typeof e.open?(e.open=i,e.high=i,e.low=i):i=e.open+i,e.high=Math.max(e.high,i),e.low=Math.min(e.low,i),e.close=i,{time:t,open:e.open,high:e.high,low:e.low,close:e.close}}},cum:{next:x,update(e,t){if(!isNaN(t))return"undefined"===typeof e.open&&(e.open=t),e.close=e.open+t,e.close}},pivot_high:{args:[{},{length:!0},{length:!0}],state:{points:[],count:0},next:E,update(e,t,i,s){e.output=t;let a=e.points[i];"undefined"===typeof a&&(a=t);const n=i+s;for(let r=0;r<=n;r++){const i=r<n-1?e.points[r]:t;if(i>a)return null}return a}},pivot_low:{args:[{},{length:!0},{length:!0}],state:{points:[],count:0},next:E,update(e,t,i,s){e.output=t;let a=e.points[i];"undefined"===typeof a&&(a=t);const n=i+s;for(let r=0;r<=n;r++){const i=r<n-1?e.points[r]:t;if(i<a)return null}return a}},highest:{args:[{},{length:!0}],state:{points:[],count:0},next:E,update(e,t,i){return e.output=t,e.count>1?Math.max.apply(null,e.points):t}},lowest:{args:[{},{length:!0}],state:{points:[],count:0},next:E,update(e,t,i){return e.output=t,e.count>1?Math.min.apply(null,e.points):t}},linreg:{args:[{},{length:!0}],state:{points:[],count:0},next:E,update(e,t,i){if(e.output=t,e.count<1)return null;let s=0,a=0,n=0,r=0,o=0,c=0;for(let p=0;p<=e.points.length;p++){const i=p===e.points.length?t:e.points[p];a=p+1,n+=a,r+=i,o+=a*a,c+=i*a,s++}const l=(s*c-n*r)/(s*o-n*n),h=r/s,d=h-l*n/i+l;return d+l*(s-1)}},avg:{update(e,t){let i=0,s=0;for(let a=0;a<t.length;a++)null!==t[a]&&(s+=t[a],i++);return s/i}},sum:{args:[{},{length:!0}],state:{count:0,sum:0,points:[]},next:R,update(e,t){return e.output=t,e.sum+t}},sma:{args:[{},{length:!0}],state:{count:0,sum:0,points:[]},next:R,update(e,t){const i=(e.sum+t)/(e.count+1);return e.output=t,i}},cma:{args:[{},{length:!0}],state:{count:0,sum:0,points:[]},next:R,update(e,t){return e.output=(e.sum+t)/(e.count+1),e.output}},ema:{args:[{},{length:!0}],state:{count:0,sum:0,points:[]},next:R,update(e,t,i){const s=2/(i+1);if(e.count){const i=e.points[e.points.length-1];e.output=(t-i)*s+i}else e.output=t;return e.output}},last:{args:[{},{length:!0}],state:{points:[],count:0},next:E,update(e,t){return e.output=t,e.count?e.points[0]:t}},rma:{args:[{},{length:!0}],state:{count:0,sum:0,points:[]},next:R,update(e,t,i){const s=1/i;if(e.count){const i=e.points[e.points.length-1];e.output=s*t+(1-s)*i}else e.output=1;return e.output}},merge_overlapping_intervals:{args:[{},{},{}],state:{count:0,sum:0,points:[]},update(e,t,i,s){return t.length?t.sort((e,t)=>e.range[0]-t.range[0]).reduce((e,t,i)=>{const s=e.length-1;return i&&e[s].range[1]>=t.range[0]?(e[s].bottom=(e[s].bottom*e[s].strength+t.range[0]*t.strength)/(e[s].strength+t.strength),e[s].top=(e[s].top*e[s].strength+t.range[1]*t.strength)/(e[s].strength+t.strength),e[s].range=[Math.min(t.range[0],e[s].range[0]),Math.max(t.range[1],e[s].range[1])],e[s].ids.push(t.id),e[s].strength+=t.strength,e):(t.bottom=Math.min(t.range[0],t.range[1]),t.top=Math.max(t.range[0],t.range[1]),e.push({...t,ids:[t.id]}),e)},[]).reduce((e,t)=>(t.strength<(i||1)||(t.range=[t.bottom,t.top],e.push(t)),e),[]):[]}},stoch:{args:[null,null,null,{length:!0}],state:{count:0,lows:[],highs:[]},next:T,update(e,t,i,s){e.low=s;const a=e.count>0?Math.min(Math.min.apply(null,e.lows),s):s;e.high=i;const n=e.count>0?Math.max(Math.max.apply(null,e.highs),i):i;return e.output=100*(t-a)/(n-a||1),e.output}},na(e){return e||0}};class A{constructor(){this.chunks=[],this.cacheRange={from:null,to:null},this.initialPrices={}}saveChunk(e){let t;if(!this.chunks.length||this.chunks[this.chunks.length-1].to<e.from)t=this.chunks.push(e)-1;else{if(!(this.chunks[0].from>e.to))return;this.chunks.unshift(e),t=0}return 0===t&&(this.cacheRange.from=e.from),t===this.chunks.length-1&&(this.cacheRange.to=e.to),e}clear(){this.chunks.splice(0,this.chunks.length),this.cacheRange.from=this.cacheRange.to=null,this.initialPrices={}}trim(e){if(!this.chunks.length)return;let t=!1;while(this.chunks[0]&&this.chunks[0].to<e)this.chunks.splice(0,1),t=!0;return this.cacheRange.from=this.chunks[0].from,t}}const M="vars",P="fns",L={candlestick:"ohlc",bar:"ohlc",line:"number",histogram:"number",area:"number",cloudarea:"range",brokenarea:"range",baseline:"number"};class D{build(e,t,i){this.paneId=i,this.indicatorId=e.id,this.serieIndicatorsMap=t,this.markets=[];for(const a of o["b"].state.panes.panes[this.paneId].markets)-1===this.markets.indexOf(a)&&this.markets.push(a);const s=this.parse(e.script);for(const a of s.functions)this.determineFunctionState(a);for(const a of s.variables)this.determineVariableState(a);return{output:s.output,functions:s.functions,variables:s.variables,references:s.references,markets:s.markets,sources:s.sources,plots:s.plots}}normalizeCommonVariables(e){return e=e.replace(/([^.])?\b(indicatorId)\b/gi,`$1'${this.indicatorId}'`),e=e.replace(/([^.])?\b(bar)\b/gi,"$1renderer"),e=e.replace(/([^.]|^)\b(vbuy|vsell|cbuy|csell|lbuy|lsell)\b/gi,"$1renderer.bar.$2"),e=e.replace(/([^.]|^)\b(time)\b([^:])/gi,"$1renderer.localTimestamp$3"),e}determineFunctionState(e){if($[e.name],"object"!==typeof $[e.name].state)e.state={};else{e.state={};for(const i in $[e.name].state)try{e.state[i]=JSON.parse(JSON.stringify($[e.name].state[i]))}catch(t){e.state[i]=$[e.name].state[i]}}}determineVariableState(e){e.length>1?e.state=[0]:e.state=0}parse(e){const t=[],i=[],s=[],a={},n=[],r=[],o=[];let c=this.parseSources(e,n);c=this.normalizeCommonVariables(c),c=this.parseStrings(c,o),c=this.parseVariables(c,i),c=this.parseMarkets(c,a);for(let l=0;l<o.length;l++)c=c.replace(new RegExp("#STRING_"+l+"#","g"),o[l].replace(/\$/g,"$$$"));return c=this.parseFunctions(c,t,s),c=this.parseReferences(c,r,s),c=this.formatOutput(c),{output:c,functions:t,variables:i,plots:s,markets:a,references:r,sources:n}}parseStrings(e,t){e=e.replace(/(\n|^)\s*?\/\/.*/g,"");const i=/'([^']*)'|"([^"]*)"/;let s=null,a=0;do{if(s=i.exec(e)){let i=t.indexOf(s[0]);-1===i&&(i=t.push(s[0])-1),e=e.slice(0,s.index)+"#STRING_"+i+"#"+e.slice(s.index+s[0].length)}}while(s&&++a<1e3);const n=/\(/g;let r;a=0;do{if(r=n.exec(e)){const t=Object(l["h"])(e,r.index,/\(|{|\[/,/\)|}|\]/);if(-1!==t){const i=e.slice(r.index+1,t).replace(/\n/g," ");e=e.slice(0,r.index)+e.slice(r.index,r.index+1)+i.replace(/\n/g,"")+e.slice(t,t+1)+"\n"+e.slice(t+1,e.length),n.lastIndex=t}}}while(r&&++a<1e3);return e}formatOutput(e){const t=/\(|{|\[/g;let i,s=0;do{if(i=t.exec(e)){const s="("===i[0],a=Object(l["h"])(e,i.index,/\(|{|\[/,/\)|}|\]/),n=e.slice(i.index+1,a).replace(/\n/g," ");/if|for|else/.test(e.slice(i.index-2,2))&&(e=e.slice(0,i.index)+e.slice(i.index,i.index+1)+n+e.slice(a,a+1)+(s?"\n":"")+e.slice(a+1,e.length)),t.lastIndex=a}}while(i&&++s<1e3);const a=e.trim().split(/\n/);for(let n=0;n<a.length;n++){const e=a[n].match(/renderer.sources\['[\w/:_-]+']\.\w+/g);e&&1===e.length&&(a[n]=`if (${e[0]}) {\n          ${a[n]}\n        }`)}return a.join("\n").replace(/\n\n/g,"\n")}parseVariables(e,t){const i=/(?:^|\n)\s*((?:var )?[a-zA-Z0-9_]+)\(?(\d*)\)?\s*=\s*([^\n;,]*)?/;let s=null,a=0;const n=[];do{if(s=i.exec(e)){let i=s[1];const a=/^var/.test(i);if(-1!==n.indexOf(i)||a){a&&(i=i.replace(/var\s*/,""),e=e.replace(s[0],"\nvar "+i+"="+s[3]),n.push(i)),e=e.replace(new RegExp("([^.$]|^)\\b("+i+")\\b(?!:)(?!\\()(?!\\$)","ig"),`$1${i}$`);continue}const r=+s[2]||1;e=e.replace(new RegExp("([^.]|^)\\b("+i+")\\b(?!:)","ig"),`$1${M}[${t.length}]`);const o={length:r};t.push(o),e=e.replace(new RegExp(`(${M}\\[${t.length-1}\\])\\(${o.length}\\)\\s*=\\s*`),"$1=")}}while(s&&++a<1e3);return e=this.determineVariablesType(e,t),e}parseSerie(e,t,i){const s=t[1].replace(/^plot/,""),a=Object(l["h"])(e,t.index+t[1].length),n=e.slice(t.index+t[1].length+1,a),r=t[1]+"("+n+")",o=Object(l["v"])(n),c=this.parseCustomArguments(o,1),h=`renderer.indicators['${this.indicatorId}'].series[${i.length}]`;let d=h+" = ";const p=L[s];let u="renderer.localTimestamp";c.offset&&(u+="+renderer.timeframe*"+c.offset);const g=/{/.test(o[0])&&/}/.test(o[0]),f=/^[\w_$]+\$/.test(o[0]);if(1===o.length&&(g||"line"!==s&&f))d+=o[0];else if("ohlc"===p)if(4===o.length)d+=`{ time: ${u}, open: ${o[0]}, high: ${o[1]}, low: ${o[2]}, close: ${o[3]} }`;else{if(1!==o.length)throw new Error(`Invalid input for function ${t[1]}, expected a ohlc object or 4 number`);/^[A-Z_]+:\w+/.test(o[0])?d+=`${o[0]}.close === null ? { time: ${u} } : { time: ${u}, open: ${o[0]}.open, high: ${o[0]}.high, low: ${o[0]}.low, close: ${o[0]}.close }`:d+=o[0]}else if("range"===p){if(2!==o.length)throw new Error(`Invalid input for function ${t[1]}, expected 2 arguments (lowerValue and higherValue)`);d+=`{ time: ${u}, lowerValue: ${o[0]}, higherValue: ${o[1]} }`}else if("number"===p){if(1!==o.length)throw new Error(`Invalid input for function ${t[1]}, expected 1 value (number)`);d+=`{ time: ${u}, value: ${o[0]} }`}let b;e=e.replace(r,d),"string"===typeof c.id&&c.id.length?(b=c.id,delete c.id):b=0===i.length?this.indicatorId:Object(l["x"])(8);const v=Object.keys(this.serieIndicatorsMap).concat(i.map(e=>e.id));return i.push({id:Object(l["B"])(b,v),type:m["p"][s]||s,expectedInput:p,options:c}),e}parseCustomArguments(e,t=0){const i={};for(let a=t;a<e.length;a++)try{const[,t,n]=e[a].match(/^(\w+)\s*=(.*)/);if(!t||!n.length)continue;let r=n.trim();try{r=JSON.parse(r)}catch(s){r=r.replace(/^'(.*)'$|^"(.*)"$/,"$1$2")}i[t.trim()]=r,e.splice(a,1),a--}catch(s){continue}return i}parseFunctions(e,t,i){const s=new RegExp("([a-zA-Z0_9_]+)\\(","g");let a=null,n=0;do{if(a=s.exec(e)){const n=a[1],r=Object.prototype.hasOwnProperty.call(Math,n),o=L[n.replace(/^plot/,"")],c="."===e[a.index-1];if(r||o||c){s.lastIndex=a.index+a[0].length,"string"===typeof o&&(e=this.parseSerie(e,a,i));continue}const h=$[n];if(!h){s.lastIndex=a.index+a[0].length;continue}const d={name:n,args:[]};let p=0;const u=a.index,m=Object(l["h"])(e,u+a[1].length),g=Object(l["v"])(e.slice(u+a[1].length+1,m));if("function"===typeof $[n]){e=`${e.slice(0,u)}utils.${n}(${d.args.map(e=>e.instruction).join(",")})${e.slice(m+1,e.length)}`;continue}let f=(h.args?h.args.length:0)+g.length;for(let e=0;e<f;e++){const t=h.args&&h.args[e]?h.args[e]:{},i={...t};if(t.injected){p++,d.args.push(i);continue}f--;const s=g[e-p];"undefined"!==typeof s&&(i.instruction=s),d.args.push(i)}e=`${e.slice(0,u)}utils.${n}.update(${P}[${t.length}].state,${d.args.map(e=>e.instruction).join(",")})${e.slice(m+1,e.length)}`,t.push(d)}}while(a&&++n<1e3);return e}parseSources(e,t){const i=new RegExp("source\\(","g");let s=null,a=0;do{if(s=i.exec(e)){const i=s.index,a=Object(l["h"])(e,i+s[0].length-1),n=Object(l["v"])(e.slice(i+s[0].length,a));let r;-1===n[0].indexOf("=")&&(r=n.shift().replace(/\W/g,""));const o=this.parseCustomArguments(n);e=e.replace(e.slice(i,a+1),`#SOURCE${t.length}#`),t.push({prop:r,filters:o})}}while(s&&++a<1e3);return e}parseMarkets(e,t){const i=/\b([A-Z_]{3,}:[a-zA-Z0-9/_-]{5,})(:[\w]{4,})?\.?([a-z]{3,})?\b/g;let s=null,a=0;do{if(s=i.exec(e)){const a=s[1]+(s[2]?s[2]:""),n=s[3];t[a]||(t[a]=[]),n&&-1===t[a].indexOf(n)&&t[a].push(n);const r=`renderer.sources['${a}']${n?"."+n:""}`;i.lastIndex=s.index+r.length,e=e.slice(0,s.index)+r+e.slice(s.index+s[0].length)}}while(s&&++a<1e3);return e}parseReferences(e,t,i){const s=new RegExp("\\$(\\w+[a-z_\\-0-9]+)\\b");let a=null,n=0;do{if(a=s.exec(e)){const s=a[1];try{const[a,n]=this.getSeriePath(s,i);t.find(e=>e.indicatorId===a&&e.plotIndex===n)||t.push({indicatorId:a,serieId:s,plotIndex:n}),e=e.replace(new RegExp("\\$("+s+")\\b","ig"),`renderer.indicators['${a}'].series[${n}]`)}catch(r){throw{message:`The serie "${s}" was not found in the current indicators`,status:"indicator-required",serieId:s}}}}while(a&&++n<1e3);return e}getSeriePath(e,t){let i,s;const a=t.find(t=>t.id===e||t.id.replace(/\W/g,"")===e.replace(/\W/g,""));if(a&&(i=this.indicatorId,s=t.indexOf(a)),!i&&this.serieIndicatorsMap[e]&&({indicatorId:i,plotIndex:s}=this.serieIndicatorsMap[e]),i||-1===Object.values(this.serieIndicatorsMap).map(e=>e.indicatorId).indexOf(e)||(i=e,s=0),i)return[i,s]}determineVariablesType(e,t){for(const i of t){const s=t.indexOf(i),a=new RegExp(`${M}\\[${s}\\](?:\\[(\\d+)\\])?`,"g");let n=null,r=0;do{if(n=a.exec(e)){const t=n[1],r=n.index+n[0].length;if("undefined"===typeof t){const t="["===e[r];e=e.substring(0,r)+".state"+(t?"":"[0]")+e.substring(r)}else{const i=e.substring(0,n.index),r=`${M}[${s}].state[Math.min(${M}[${s}].state.length-1,${t})]`,o=e.substring(n.index+n[0].length);e=`${i}${r}${o}`,a.lastIndex=i.length+r.length}i.length=Math.max(i.length,(+t||0)+1)}}while(n&&++r<1e3);if(!i.length)throw new Error("Unexpected no length on var");1===i.length&&(e=e.replace(new RegExp(`${M}\\[${s}\\]\\.state\\[\\d+\\]`,"g"),`${M}[${s}].state`)),e=e.replace(new RegExp(`#${M}\\[${s}\\]\\.state\\[\\d+\\]`,"g"),`${M}[${s}].state`)}return e}getSourcedOutput(e,t){const i=o["b"].state.panes.marketsListeners;let s=e.output;const a=["open","high","low","close"];for(let n=0;n<e.sources.length;n++){const r=[],o=`#SOURCE${n}#`,c=e.sources[n].prop,l=e.sources[n].filters;for(const e in t)l.type&&i[e].type!==l.type||l.exchange&&i[e].exchange!==l.exchange||l.quote&&i[e].quote!==l.quote||r.push(e);r.length?s=c?-1!==a.indexOf(c)?s.replace(o,`(() => {\n              let count = 0;\n              let sum = 0;\n              ${r.map(e=>`if (renderer.sources['${e}'].${c}) {\n                count++;\n                sum += renderer.sources['${e}'].${c}\n              }`).join(";")}\n              return sum / count\n            })()`):s.replace(o,`(${r.map(e=>`renderer.sources['${e}'].${c}`).join("+")})`):s.replace(o,`{\n            timestamp: renderer.timestamp,\n            localTimestamp: renderer.localTimestamp,\n            sources: {\n              ${r.map(e=>`'${e}': renderer.sources['${e}']`).join(",")}\n            },\n          }`):s=s.replace(o,"0")}return s}getAdapter(e,t){let i=e.output;return e.sources.length&&(i=this.getSourcedOutput(e,t)),function(){return new Function("renderer",P,M,"series","options","utils",'"use strict"; '+i)}()}getRendererIndicatorData(e){const{functions:t,variables:i,plots:s}=JSON.parse(JSON.stringify(e.model));e.options.minLength=0;for(const r of t){r.length=0;for(let t=0;t<r.args.length;t++)if("undefined"!==typeof r.args[t].instruction&&""!==r.args[t].instruction)try{r.args[t].instruction=new Function("options","'use strict'; return "+r.args[t].instruction)(e.options),r.args[t].length&&!isNaN(r.args[t].instruction)&&(r.length+=r.args[t].instruction)}catch(n){}e.options.minLength=Math.max(e.options.minLength,r.length)}const a=[];for(const r of s)a.push(this.getCustomPlotOptions(e,r));return{canRender:e.options.minLength<=1,series:[],functions:t,variables:i,plotsOptions:a,minLength:e.options.minLength}}getCustomPlotOptions(e,t){const i={};for(const a in t.options)try{i[a]=new Function("options","'use strict'; return "+t.options[a])(e.options)}catch(s){i[a]=t.options[a]}return i}}var j=i("722a"),z=i("8766");class N{constructor(e,t){this.isBusy=!1,this.chart=e,!this.chart.isLoading&&this.initialize(t)&&this.bindEvents(t)}initialize(e){if(this.api=this.chart.getPriceApi(),!this.api)return!1;this.offset=Object(z["a"])(e),this.originalOffset={...this.offset};const t=this.api.coordinateToPrice(this.offset.y);if(!t)return!1;this.priceline=this.api.getPriceLine(t,this.chart.chartInstance.timeScale().coordinateToLogical(this.offset.x));const i=o["b"].state.settings.alertsClick||e.altKey;return!(!this.priceline&&!i)&&(this.referencePrice=this.chart.getPrice(),this.timestamp=Date.now(),this.alert=this.getAlert(t),!0)}getMoveEvent(e){return/touch/.test(e.type)?"touchmove":"mousemove"}getEndEvent(e){return/touch/.test(e.type)?"touchend":"mouseup"}bindEvents(e){const t=this.chart.getChartCanvas();this.levelDragMoveHandler=this.onLevelDragMove.bind(this),this.levelDragEndHandler=this.onLevelDragEnd.bind(this),t.addEventListener(this.getMoveEvent(e),this.levelDragMoveHandler),t.addEventListener(this.getEndEvent(e),this.levelDragEndHandler)}getAlert(e){let t;if(this.priceline){const i=this.priceline.options();t=i.market,i.market?(t=i.market,e=i.price):this.priceline=null}return t||(t=this.chart.mainIndex),{price:e,market:t}}onLevelDragMove(e){const{x:t,y:i}=Object(z["a"])(e),s=Math.abs(this.originalOffset.y-i)>5||Date.now()-this.timestamp>750;if(this.offset.x=t,this.offset.y=i,this.priceline){if(e.stopPropagation(),!s)return;const t=y["b"].formatPrice(this.api.coordinateToPrice(i));let a;if(!this.moved){const e=Object(d["l"])(o["b"].state.settings.alertsColor);a=Object(d["j"])([e[0],e[1],e[2],.5*(e[3]||1)])}this.priceline.applyOptions({price:t,color:a}),this.moved=!0}else s&&this.unbindEvents(e)}async onLevelDragEnd(e){const t=Math.abs(this.originalOffset.y-this.offset.y)>5||Date.now()-this.timestamp>750,i=!this.priceline&&!t&&Math.abs(this.originalOffset.x-this.offset.x)+Math.abs(this.originalOffset.y-this.offset.y)<10;o["b"].state.settings.alerts&&(e.altKey||o["b"].state.settings.alertsClick);const s=this.alert.market;if((this.priceline||i)&&this.chart.chartInstance.clearCrosshairPosition(),this.unbindEvents(e),!this.chart.isLoading){if(this.isBusy=!0,this.priceline){const e=y["b"].alerts[this.alert.market].find(e=>e.price===this.alert.price),{price:i,title:a}=this.priceline.options(),n={active:!1,price:i,market:s,message:a};this.alert.price!==i&&t?(await y["b"].moveAlert(e.market,e.price,n,this.referencePrice),this.api.removePriceLine(this.priceline)):await y["b"].removeAlert(this.alert)}else if(i){const e=this.chart.chartInstance.timeScale().coordinateToTime(this.offset.x),t={price:this.alert.price,market:this.alert.market,timestamp:e,active:!1};await y["b"].createAlert(t,this.chart.getPrice())}this.isBusy=!1}}unbindEvents(e){const t=this.chart.getChartCanvas();t.removeEventListener(this.getEndEvent(e),this.levelDragEndHandler),this.levelDragEndHandler=null,t.removeEventListener(this.getMoveEvent(e),this.levelDragMoveHandler),this.levelDragMoveHandler=null}}class H{constructor(e,t){this.isBusy=!1,this.chart=e,this.canvas=this.chart.getChartCanvas(),this.initialize(t)&&this.bindEvents(t)}initialize(e){var t;if(this.api=this.chart.getPriceApi(),!this.api)return!1;const{x:i,y:s}=Object(l["n"])(e,!0),{top:a,left:n}=this.canvas.getBoundingClientRect();return this.top=a,this.height=this.canvas.height,this.left=n,this.width=this.canvas.width,this.a={x:Math.max(0,Math.min(this.width,i-n)),y:Math.max(0,Math.min(this.height,s-a))},this.a.price=this.api.coordinateToPrice(this.a.y),this.a.time=null===(t=this.chart.chartInstance.timeScale())||void 0===t?void 0:t.coordinateToTime(this.a.x),!!this.a.price&&(this.market=this.chart.mainIndex,!0)}getMoveEvent(e){return/touch/.test(e.type)?"touchmove":"mousemove"}getEndEvent(e){return/touch/.test(e.type)?"touchend":"mouseup"}getClearEvent(){return/touch/.test(event.type)?"touchstart":"mousedown"}bindEvents(e){this.chart.chartInstance.applyOptions({handleScroll:!1}),this.onMoveHandler=this.onMove.bind(this),this.onEndHandler=this.onEnd.bind(this),document.body.addEventListener(this.getMoveEvent(e),this.onMoveHandler),document.body.addEventListener(this.getEndEvent(e),this.onEndHandler)}onPan(){const e=this.chart.chartInstance.timeScale();e&&(this.a.x=e.timeToCoordinate(this.a.time),this.b.x=e.timeToCoordinate(this.b.time)),this.a.y=this.api.priceToCoordinate(this.a.price),this.b.y=this.api.priceToCoordinate(this.b.price),this.updateComponent()}onMove(e){var t;const{x:i,y:s}=Object(l["n"])(e,!0);this.b={x:Math.max(0,Math.min(this.width,i-this.left)),y:Math.max(0,Math.min(this.height,s-this.top))},this.b.price=this.api.coordinateToPrice(this.b.y),this.b.time=null===(t=this.chart.chartInstance.timeScale())||void 0===t?void 0:t.coordinateToTime(this.b.x),this.measurementComponent?this.updateComponent():this.createComponent()}getPropsData(){const e=[this.a.x,this.b.x].sort((e,t)=>e-t),t=[this.a.y,this.b.y].sort((e,t)=>e-t),i=[this.a.price,this.b.price].sort((e,t)=>e-t),s=-1*(1-this.b.price/this.a.price)*100;return{position:{top:t[0],left:e[0],width:e[1]-e[0],height:t[1]-t[0]},low:+Object(v["d"])(i[0],this.market),high:+Object(v["d"])(i[1],this.market),percent:s}}async createComponent(){if(this.isBusy=!0,this.isLoading)return!1;this.isLoading=!0,document.body.style.cursor="progress";const e=await i.e("chunk-1b190712").then(i.bind(null,"6ad6")),{position:t,low:s,high:a,percent:n}=this.getPropsData();this.measurementComponent=Object(l["e"])(e.default,{position:t,low:s,high:a,percent:n}),Object(l["t"])(this.measurementComponent,this.canvas.parentElement);const r=this.chart.chartInstance.timeScale();r&&(this.onPanHandler=this.onPan.bind(this),r.subscribeVisibleLogicalRangeChange(this.onPanHandler)),this.isLoading=!1,document.body.style.cursor=""}updateComponent(){const{position:e,low:t,high:i,percent:s}=this.getPropsData();this.measurementComponent.position=e,this.measurementComponent.low=t,this.measurementComponent.high=i,this.measurementComponent.percent=s}onEnd(e){this.unbindEvents(e)}async unbindEvents(e){document.body.removeEventListener(this.getEndEvent(e),this.onEndHandler),this.onEndHandler=null,document.body.removeEventListener(this.getMoveEvent(e),this.onMoveHandler),this.onMoveHandler=null,this.chart.chartInstance.applyOptions({handleScroll:!0}),this.canvas.addEventListener(this.getClearEvent(),()=>{this.destroy()},{once:!0})}removeComponent(){if(this.measurementComponent.$destroy(),this.measurementComponent.$el.parentNode.removeChild(this.measurementComponent.$el),this.measurementComponent=null,this.onPanHandler){const e=this.chart.chartInstance.timeScale();e&&e.unsubscribeVisibleLogicalRangeChange(this.onPanHandler),this.onPanHandler=null}}destroy(){this.measurementComponent&&this.removeComponent(),this.isBusy=!1}}const B=[];let G=null,F=null;class q{constructor(e){this.chart=e}bindEvents(){this.subscribeStore(),this.onPanHandler=this.onPan.bind(this),this.chart.chartInstance.timeScale().subscribeVisibleLogicalRangeChange(this.onPanHandler);const e=this.chart.chartElement;this.clickHandler=this.onClick.bind(this),e.addEventListener(Object(z["b"])()?"touchstart":"mousedown",this.clickHandler),this.contextMenuHandler=this.onContextMenu.bind(this),e.addEventListener("contextmenu",this.contextMenuHandler),this.crosshairMoveHandler=this.onCrosshairMove.bind(this),this.chart.chartInstance.subscribeCrosshairMove(this.crosshairMoveHandler),this.clearChartsCrosshairsHandler=this.clearChartsCrosshairs.bind(this),e.addEventListener("mouseleave",this.clearChartsCrosshairsHandler),o["b"].state[this.chart.paneId].showIndicators&&o["b"].state[this.chart.paneId].showLegend&&this.bindLegend(),B.push(this.chart)}unbindEvents(){this.unsubscribeStore(),this.unbindLegend(),this.chart.chartInstance.timeScale().unsubscribeVisibleLogicalRangeChange(this.onPan);{const e=this.chart.chartElement,t=Object(z["b"])()?"touchstart":"mousedown";e.removeEventListener(t,this.clickHandler),this.clickHandler=null,e.removeEventListener("contextmenu",this.contextMenuHandler),this.contextMenuHandler=null}this.chart.chartInstance.unsubscribeCrosshairMove(this.crosshairMoveHandler),this.crosshairMoveHandler=null;const e=B.indexOf(this.chart);-1!==e&&B.splice(e,1)}subscribeStore(){this.unsubscribeStore=o["b"].subscribe(e=>{switch(e.type){case this.chart.paneId+"/FLAG_INDICATOR_AS_SAVED":this.chart.saveIndicatorPreview(e.payload);break;case"settings/SET_CHART_THEME":case"settings/SET_TEXT_COLOR":this.chart.chartInstance.applyOptions(Object(m["g"])(this.chart.paneId));break;case"settings/TOGGLE_NORMAMIZE_WATERMARKS":this.chart.refreshMarkets();break;case"settings/SET_TIMEZONE_OFFSET":this.chart.setTimezoneOffset(o["b"].state.settings.timezoneOffset),this.chart.clearChart(),this.chart.renderAll();break;case"panes/SET_PANE_MARKETS":e.payload.id===this.chart.paneId&&(o["b"].state[this.chart.paneId].hiddenMarkets={},this.chart.refreshMarkets(),this.chart.clear(),this.chart.fetch());break;case"panes/SET_PANE_ZOOM":e.payload.id===this.chart.paneId&&this.chart.updateFontSize();break;case this.chart.paneId+"/SET_TIMEFRAME":this.chart.clear(),this.chart.fetch();break;case"settings/TOGGLE_ALERTS":case this.chart.paneId+"/TOGGLE_ALERTS":case this.chart.paneId+"/TOGGLE_ALERTS_LABEL":case"settings/SET_ALERTS_COLOR":case"settings/SET_ALERTS_LINESTYLE":case"settings/SET_ALERTS_LINEWIDTH":case"app/EXCHANGE_UPDATED":case this.chart.paneId+"/TOGGLE_MARKET":this.chart.refreshMarkets(),this.chart.renderAll();break;case this.chart.paneId+"/SET_REFRESH_RATE":this.chart.clearQueue(),this.chart.setupQueue();break;case this.chart.paneId+"/TOGGLE_LEGEND":case this.chart.paneId+"/TOGGLE_INDICATORS":o["b"].state[this.chart.paneId].showIndicators&&o["b"].state[this.chart.paneId].showLegend?this.bindLegend():this.unbindLegend();break;case this.chart.paneId+"/SET_GRIDLINES":this.chart.chartInstance.applyOptions(Object(m["i"])(this.chart.paneId));break;case this.chart.paneId+"/SET_BORDER":case this.chart.paneId+"/TOGGLE_AXIS":this.chart.chartInstance.applyOptions(Object(m["f"])(this.chart.paneId));break;case this.chart.paneId+"/SET_WATERMARK":case this.chart.paneId+"/TOGGLE_NORMAMIZE_WATERMARKS":this.chart.updateWatermark();break;case this.chart.paneId+"/SET_INDICATOR_OPTION":this.chart.setIndicatorOption(e.payload.id,e.payload.key,e.payload.value,e.payload.silent);break;case this.chart.paneId+"/SET_PRICE_SCALE":e.payload.priceScale&&this.chart.refreshPriceScale(e.payload.id);break;case this.chart.paneId+"/SET_INDICATOR_SCRIPT":this.chart.rebuildIndicator(e.payload.id);break;case this.chart.paneId+"/ADD_INDICATOR":this.chart.addIndicator(e.payload.id)&&(this.chart.redrawIndicator(e.payload.id),o["b"].state[this.chart.paneId].showIndicators&&o["b"].state[this.chart.paneId].showLegend&&this.bindLegend(e.payload.id));break;case this.chart.paneId+"/REMOVE_INDICATOR":this.unbindLegend(e.payload),this.chart.removeIndicator(e.payload);break;case this.chart.paneId+"/TOGGLE_FILL_GAPS_WITH_EMPTY":this.chart.toggleFillGapsWithEmpty();break;case"settings/TOGGLE_AUTO_HIDE_HEADERS":this.chart.refreshChartDimensions();break}})}onContextMenu(e){if(window.innerWidth<375)return;const t=e.currentTarget;e.preventDefault();const{x:i,y:s}=Object(l["n"])(e,!0),{top:a,left:n}=t.getBoundingClientRect(),r=this.chart.getPriceApi(),c=this.chart.mainIndex;let h,d;if(r){const e=r.coordinateToPrice(s-a);e&&(h=y["b"].formatPrice(e));const t=this.chart.chartInstance.timeScale(),o=r.getPriceLine(h,t?t.coordinateToLogical(i-n):null);if(o){const e=o.options();d={price:e.price,market:e.market,message:e.message}}}const p=Object(l["i"])(Date.now()/1e3,this.chart.timeframe),u=o["b"].state[this.chart.paneId].timeframe,m=this.chart.paneId;this.createContextMenu({value:{top:s-1,left:i-1,width:2,height:2},market:c,price:h,timeframe:u,timestamp:p,paneId:m,alert:d,getPrice:this.chart.getPrice.bind(this.chart)})}async createContextMenu(e){if(G){G.$off("cmd");for(const t in e)G[t]=e[t]}else{document.body.style.cursor="progress";const t=await i.e("chunk-2d221416").then(i.bind(null,"ca24"));document.body.style.cursor="",G=Object(l["e"])(t.default,e),Object(l["t"])(G)}G.$on("cmd",e=>{if(!(this.chart[e[0]]instanceof Function))throw new Error(`[chart/control] ContextMenu->chart->${e[0]} is not a function`);this.chart[e[0]](...e.slice(1))})}onClick(e){if(g["a"].hasDialogOpened)return;if(g["a"].hasDialogOpened||e instanceof MouseEvent&&e.button)return;const t=this.activeEvent&&this.activeEvent.isBusy;if(e.shiftKey)this.activeEvent=new H(this.chart,e);else if(o["b"].state.settings.alerts){if(t)return;this.activeEvent=new N(this.chart,e)}}onCrosshairMove(e){e&&e.point&&(this.syncCrosshair(e),this.lastCrosshairX!==e.point.x&&(this.lastCrosshairX=e.point.x,this.legendElements&&this.updateLegend(e)))}onPan(e){!e||this.chart.panPrevented||this.chart.isLoading||"tick"===this.chart.type||(this.onPanTimeout&&(clearTimeout(this.onPanTimeout),this.onPanTimeout=null),this.onPanTimeout=setTimeout(()=>{this.onPanTimeout=null,null!==this.chart.chartCache.cacheRange.from&&(e=this.chart.chartInstance.timeScale().getVisibleLogicalRange(),this.chart.savePosition(e),this.chart.fetchMore(e))},500))}async bindLegend(e){if(this.legendElements||(this.legendElements={}),!e){for(const e in o["b"].state[this.chart.paneId].indicators)this.bindLegend(e);return}await Object(l["y"])(1);const t=this.chart.paneId+e;if(this.legendElements[t])return;const i=document.getElementById(t);i&&(this.legendElements[t]=i)}unbindLegend(e){if(!this.legendElements)return;if(!e){for(const e of this.chart.loadedIndicators)this.unbindLegend(e.id);return void(this.legendElements=null)}const t=this.chart.paneId+e;for(const i in this.legendElements)if(t===i)return this.legendElements[i].innerText="",void delete this.legendElements[i]}clearChartsCrosshairs(){if(this.isSyncingCrosshairs){for(let e=0;e<B.length;e++)B[e].chartInstance.setCrosshair(null,null,null);this.isSyncingCrosshairs=!1}}syncCrosshair(e){let t;if(e.point&&e.point.y){const i=this.chart.getPrice(),s=this.chart.getPriceApi();if(i&&s){const a=s.coordinateToPrice(e.point.y);t=-1*(1-a/i)}}for(let i=0;i<B.length;i++){if(B[i].paneId===this.chart.paneId)continue;const s=B[i].getPriceApi(),a=B[i].chartInstance.timeScale();let n,r;if(e.time&&a&&(n=a.timeToCoordinate(Object(l["i"])(+e.time,B[i].timeframe,B[i].isOddTimeframe))),s){const e=B[i].getPrice();r=s.priceToCoordinate(e+e*t)}B[i].chartInstance.setCrosshair(n,r,!0),this.isSyncingCrosshairs=!0}}updateLegend(e){for(let t=0;t<this.chart.loadedIndicators.length;t++){const i=this.chart.loadedIndicators[t];if(!i.apis.length)continue;const s=this.chart.paneId+i.id;if(!this.legendElements[s])continue;if(!e.point.x)continue;let a="";for(let t=0;t<i.apis.length;t++){if(t>10)break;const s=i.apis[t],n=e.seriesData.get(s);if(a.length&&(a+=" | "),!n){a+="na";continue}let r,o="price";i.options.priceFormat&&(i.options.priceFormat.type&&(o=i.options.priceFormat.type),r=i.options.priceFormat.precision);const c="volume"===o?v["c"]:v["e"];n.value?a+=c(n.value,r):n.close&&(a+=`O: ${c(n.open,r)} H: ${c(n.high,r)} L: ${c(n.low,r)} C: ${c(n.close,r)}`)}this.legendElements[s].textContent=a}}async toggleTimeframeDropdown(e){const t={value:e.currentTarget,paneId:this.chart.paneId};if(F)F.value===e.currentTarget?F.value=null:(F.paneId=t.paneId,F.value=t.value);else{const e=await i.e("chunk-51a46134").then(i.bind(null,"f2f7"));F=Object(l["e"])(e.default,t),Object(l["t"])(F)}}}class W{constructor(e,t){this.loadedIndicators=[],this.renderedRange={from:null,to:null},this.marketsFilters={},this.marketsIndexes=[],this.timezoneOffset=0,this.fillGapsWithEmpty=!0,this.priceScales=[],this.isLoading=!1,this.hasReachedEnd=!1,this.queuedTrades=[],this.seriesIndicatorsMap={},this._queueHandler=this.releaseQueue.bind(this),this._refreshDecimalsHandler=this.refreshAutoDecimals.bind(this),this.paneId=e,this.chartElement=t,this.chartCache=new A,this.serieBuilder=new D,this.initialize()}initialize(){this.createChart(),this.setupQueue(),this.setupRecycle(),this.setTimeframe(o["b"].state[this.paneId].timeframe),this.setTimezoneOffset(o["b"].state.settings.timezoneOffset),this.refreshMarkets(),this.fetch(),f["a"].on("decimals",this._refreshDecimalsHandler),this.fillGapsWithEmpty=Boolean(o["b"].state[this.paneId].fillGapsWithEmpty)}async refreshMarkets(){if(o["b"].state.app.isExchangesReady)this._promiseOfMarkets&&(this._promiseOfMarkets=null);else{if(this._promiseOfMarkets)return this._promiseOfMarkets;this._promiseOfMarkets=Object(h["d"])(e=>e.app.isExchangesReady).then(this.refreshMarkets.bind(this))}const e=o["b"].state.panes.panes[this.paneId].markets,t=o["b"].state.settings.normalizeWatermarks,i=[],s={},a={};for(const n of e){const[e]=n.split(":"),r=o["b"].state.panes.marketsListeners[n];let c=n;r&&(c=Object(v["o"])(r.local)),a[n]=o["b"].state.exchanges[e]&&!o["b"].state.exchanges[e].disabled&&!o["b"].state[this.paneId].hiddenMarkets[n],a[n]&&-1===i.indexOf(c)&&i.push(t&&r?c:n),s[c]||(s[c]=0),s[c]++}this.marketsFilters=a,this.marketsIndexes=Object.keys(s),this.mainIndex=this.marketsIndexes.reduce((e,t)=>(e.push({index:t,count:this.marketsIndexes[t]}),e),[]).sort((e,t)=>t.count-e.count)[0].index,this.updateWatermark(i),this.resetPriceScales(),this.refreshAutoDecimals()}setTimeframe(e){/t$/.test(e)?this.type="tick":this.type="time",this.timeframe=parseFloat(e),this.isOddTimeframe=Object(l["s"])(this.timeframe),this.updateWatermark()}setTimezoneOffset(e){const t=this.timezoneOffset;this.timezoneOffset=e/1e3;const i=this.timezoneOffset-t;this.activeRenderer&&(this.activeRenderer.localTimestamp+=i)}createChart(){const e=u()(Object(m["j"])(m["a"],this.paneId),Object(m["l"])(this.paneId),Object(m["i"])(this.paneId),Object(m["e"])(this.paneId,this.chartElement.clientWidth));this.chartInstance=Object(j["c"])(this.chartElement,e),this.addEnabledSeries(),this.updateWatermark(),this.updateFontSize(),this.chartControl||(this.chartControl=new q(this)),this.chartControl.bindEvents()}removeChart(){this.chartControl.unbindEvents(),this.priceScales.splice(0,this.priceScales.length);while(this.loadedIndicators.length)this.removeIndicator(this.loadedIndicators[0]);this.chartInstance&&(this.chartInstance=null,this.chartElement.innerHTML="")}getLoadedIndicator(e){for(let t=0;t<this.loadedIndicators.length;t++)if(this.loadedIndicators[t].id===e)return this.loadedIndicators[t]}setIndicatorOption(e,t,i,s=!1){const a=this.getLoadedIndicator(e);if(a&&(a.options[t]=i,!s))if("visible"!==t){"priceFormat"===t?i.auto&&setTimeout(()=>this.refreshAutoDecimals(null,e)):"priceScaleId"===t&&this.ensurePriceScale(i,a);for(let e=0;e<a.apis.length;e++)a.apis[e].applyOptions({[t]:i});this.optionRequiresRedraw(t)&&this.redrawIndicator(e)}else this.toggleIndicatorVisibility(a,i)}toggleIndicatorVisibility(e,t){t?(e.model?this.createIndicatorSeries(e):this.prepareIndicator(e),this.redrawIndicator(e.id)):this.removeIndicatorSeries(e)}optionRequiresRedraw(e){const t=/upColor|downColor|wickDownColor|wickUpColor|borderDownColor|borderUpColor|compositeOperation/i;if(t.test(e))return!0;const i=/color|priceFormat|linetype|width|style/i;return!i.test(e)}rebuildIndicator(e){this.removeIndicator(this.getLoadedIndicator(e)),this.addIndicator(e)&&this.redrawIndicator(e)}getReferencedIndicators(e){return e.model.references.slice().map(e=>e.indicatorId).filter((e,t,i)=>i.indexOf(e)===t)}redrawIndicator(e,t,i){const s=this.getLoadedIndicator(e);this.clearIndicatorSeries(s);let a=[];for(const n of this.chartCache.chunks)a=t||i?a.concat(n.bars.filter(e=>(!t||e.time>=t)&&(!i||e.time<i))):a.concat(n.bars);this.renderBars(a,e)}ensureIndicatorVisible(e){for(const t of e)this.loadedIndicators[t]&&!1===this.loadedIndicators[t].options.visible&&this.setIndicatorOption(t,"visible",!0,!0)}getVisibleRange(){const e=this.chartInstance.timeScale().getVisibleRange();return e?(e.from-=this.timezoneOffset,e.to-=this.timezoneOffset,e):e}addEnabledSeries(){for(const e in o["b"].state[this.paneId].indicators)this.addIndicator(e)}updateWatermark(e){if(e)if(o["b"].state.settings.normalizeWatermarks)this.watermark=e.join(" | ");else{const t=e.length-3;this.watermark=e.slice(0,3).join(" + ")+(t>0?" + "+t+" other"+(t>1?"s":""):"")}this.chartInstance&&this.chartInstance.applyOptions({watermark:{text:`    ${this.watermark+" | "+Object(l["q"])(o["b"].state[this.paneId].timeframe)}    `,...Object(m["l"])(this.paneId).watermark}})}updateFontSize(){if(!this.chartElement)return;const e=o["b"].state.panes.panes[this.paneId].zoom||1,t=.05*this.chartElement.clientWidth*(o["b"].state.settings.normalizeWatermarks?1:.5);this.chartInstance.applyOptions({layout:{fontSize:14*e},watermark:{fontSize:Math.max(16,Math.min(144,t*e))}})}addIndicator(e,t){if(this.getLoadedIndicator(e))return!0;if(t>5)return!1;const i=o["b"].state[this.paneId].indicators[e],s=i.options||{},a={id:e,options:JSON.parse(JSON.stringify(s)),script:i.script,model:null,adapter:null,apis:[]};try{this.prepareIndicator(a)}catch(n){return"indicator-required"!==n.status||this.resolveDependency(a.id,n.serieId,t||0)||g["a"].confirm({message:`"${a.id}" indicator need the "${n.serieId}" serie but that one WAS NOT found anywhere in the current indicators.`,ok:"I see",cancel:!1}),n.status||g["a"].isDialogOpened("indicator")||g["a"].openIndicator(this.paneId,a.id),!1}return this.loadedIndicators.push(a),!0}resolveDependency(e,t,i){const s=o["b"].state[this.paneId].indicators;for(const a in s)if(a!==e&&s[a].series&&-1!==s[a].series.indexOf(t))return!!this.addIndicator(a,i+1)&&(0===i&&this.addIndicator(e,i+1),!0);return!(!s[t]||!this.addIndicator(s[t].id,i+1))&&(0===i&&this.addIndicator(e,i+1),!0)}prepareIndicator(e){try{const t=this.serieBuilder.build(e,this.seriesIndicatorsMap,this.paneId);o["b"].state[this.paneId].indicatorsErrors[e.id]&&o["b"].commit(this.paneId+"/SET_INDICATOR_ERROR",{id:e.id,error:null}),e.model=t,!1!==e.options.visible&&this.createIndicatorSeries(e)}catch(t){if(!1!==e.options.visible)throw o["b"].commit(this.paneId+"/SET_INDICATOR_ERROR",{id:e.id,error:t.message}),t}}bindIndicator(e,t){if(t&&"undefined"===typeof t.indicators[e.id]&&e.model){if(t.indicators[e.id]=this.serieBuilder.getRendererIndicatorData(e),!this.activeRenderer||t===this.activeRenderer){for(let i=0;i<t.indicators[e.id].plotsOptions.length;i++)e.apis[i].applyOptions(t.indicators[e.id].plotsOptions[i]);try{e.adapter=this.serieBuilder.getAdapter(e.model,this.marketsFilters)}catch(i){throw this.unbindIndicator(e,t),i}}return this.prepareRendererForIndicators(e,t),e}}unbindIndicator(e,t){t&&"undefined"!==typeof t.indicators[e.id]&&delete t.indicators[e.id]}ensurePriceScale(e,t){if(-1!==this.priceScales.indexOf(e))return;this.priceScales.push(e);let i=o["b"].state[this.paneId].priceScales[e];i||(i={},t&&t.options.scaleMargins?i.scaleMargins=t.options.scaleMargins:i.scaleMargins={top:.1,bottom:.2},o["b"].commit(this.paneId+"/SET_PRICE_SCALE",{id:e,priceScale:i})),this.refreshPriceScale(e)}resetPriceScales(){for(let e=0;e<this.priceScales.length;e++)this.chartInstance.priceScale(this.priceScales[e]).applyOptions({autoScale:!0})}removeIndicator(e){"string"===typeof e&&(e=this.getLoadedIndicator(e)),e&&(this.removeIndicatorSeries(e),this.loadedIndicators.splice(this.loadedIndicators.indexOf(e),1))}clearChart(e){e||this.preventPan();for(const t of this.loadedIndicators)this.clearIndicatorSeries(t);this._alertsRendered=!1,this.renderedRange.from=this.renderedRange.to=null}clearData(){this.activeRenderer=null,this.activeChunk=null,this.queuedTrades.splice(0,this.queuedTrades.length)}clearPriceLines(e){for(let t=0;t<this.loadedIndicators.length;t++)if(!e||-1!==e.indexOf(this.loadedIndicators[t].id)){this._priceIndicatorId===this.loadedIndicators[t].id&&(this._alertsRendered=!1);for(let e=0;e<this.loadedIndicators[t].apis.length;e++)this.loadedIndicators[t].apis[e].removeAllPriceLines()}}clear(){this.chartCache.clear(),this.clearData(),this.clearChart(),this.hasReachedEnd=!1,this.setTimeframe(o["b"].state[this.paneId].timeframe)}getActiveChunk(){return this.activeChunk||this.chartCache.cacheRange.to!==this.activeRenderer.timestamp?(this.activeChunk&&(this.activeChunk.active=!1),this.activeChunk=this.chartCache.saveChunk({from:this.activeRenderer.timestamp,to:this.activeRenderer.timestamp,active:!0,rendered:!0,bars:[]})):(this.activeChunk=this.chartCache.chunks[this.chartCache.chunks.length-1],this.activeChunk.active=!0),this.activeChunk}destroy(){this.chartCache.clear(),this.clearData(),this.clearChart(),this.removeChart(),this.clearQueue(),this.clearRecycle(),f["a"].off("decimals",this._refreshDecimalsHandler)}clearIndicatorSeries(e){e.id===this._priceIndicatorId&&(this._priceIndicatorId=null,this._priceApi=null);for(let t=0;t<e.apis.length;t++)e.apis[t].removeAllPriceLines(),e.apis[t].setData([])}setupQueue(){this._releaseQueueInterval||(o["b"].state[this.paneId].refreshRate?this._releaseQueueInterval=setInterval(this._queueHandler,o["b"].state[this.paneId].refreshRate):this._releaseQueueInterval=requestAnimationFrame(this._queueHandler))}clearQueue(){this._releaseQueueInterval&&(clearInterval(this._releaseQueueInterval),cancelAnimationFrame(this._releaseQueueInterval),delete this._releaseQueueInterval,this.releaseQueue())}releaseQueue(){if(this.queuedTrades.length)try{this.renderRealtimeTrades(this.queuedTrades),this.queuedTrades.splice(0,this.queuedTrades.length)}catch(e){}}queueTrades(e){Array.prototype.push.apply(this.queuedTrades,e),o["b"].state[this.paneId].refreshRate||(this._releaseQueueInterval=requestAnimationFrame(this._queueHandler))}renderRealtimeTrades(e){if(e.length){for(let t=0;t<e.length;t++){const i=e[t],s=i.exchange+":"+i.pair;if("undefined"===typeof this.marketsFilters[s])continue;let a;if(a=this.activeRenderer?"time"===this.activeRenderer.type?Object(l["i"])(i.timestamp/1e3,this.timeframe,this.isOddTimeframe):this.activeRenderer.bar.cbuy+this.activeRenderer.bar.csell>=this.timeframe?Math.max(this.activeRenderer.timestamp+.001,Math.round(i.timestamp/1e3)):this.activeRenderer.timestamp:i.timestamp/1e3,!this.activeRenderer||this.activeRenderer.timestamp<a)if(this.activeRenderer){(!this.activeChunk||this.activeChunk.to<this.activeRenderer.timestamp&&this.activeChunk.bars.length>=c["c"])&&this.getActiveChunk(),this.activeRenderer.bar.empty||this.updateBar(this.activeRenderer);for(const e in this.activeRenderer.sources)!1===this.activeRenderer.sources[e].empty&&this.activeChunk.bars.push(this.cloneSourceBar(this.activeRenderer.sources[e],this.activeRenderer.timestamp));this.activeChunk.to=this.chartCache.cacheRange.to=this.activeRenderer.timestamp,this.renderedRange.to<this.activeRenderer.timestamp&&(this.renderedRange.to=this.activeRenderer.timestamp),this.nextBar(a,this.activeRenderer)}else this.activeRenderer=this.createRenderer(a);const n=i.price*i.size;this.activeRenderer.sources[s]&&"undefined"!==typeof this.activeRenderer.sources[s].pair||(this.activeRenderer.sources[s]={pair:i.pair,exchange:i.exchange,close:+i.price,active:this.marketsFilters[s]},this.resetBar(this.activeRenderer.sources[s]));const r=this.marketsFilters[s];i.liquidation?(this.activeRenderer.sources[s]["l"+i.side]+=n,this.activeRenderer.bar.empty=!1,r&&(this.activeRenderer.bar["l"+i.side]+=n)):(this.activeRenderer.sources[s].close=+i.price,this.activeRenderer.sources[s].empty?this.activeRenderer.sources[s].open=this.activeRenderer.sources[s].high=this.activeRenderer.sources[s].low=this.activeRenderer.sources[s].close:(this.activeRenderer.sources[s].high=Math.max(this.activeRenderer.sources[s].high,this.activeRenderer.sources[s].close),this.activeRenderer.sources[s].low=Math.min(this.activeRenderer.sources[s].low,this.activeRenderer.sources[s].close)),this.activeRenderer.sources[s]["c"+i.side]+=i.count,this.activeRenderer.sources[s]["v"+i.side]+=n,this.activeRenderer.sources[s].empty=!1,r&&(this.activeRenderer.bar["v"+i.side]+=n,this.activeRenderer.bar["c"+i.side]+=i.count,this.activeRenderer.bar.empty=!1))}this.activeRenderer&&(this.activeRenderer.bar.empty||(this.updateBar(this.activeRenderer),this.renderedRange.to<this.activeRenderer.timestamp&&(this.renderedRange.to=this.activeRenderer.timestamp)))}}cloneSourceBar(e,t){return{pair:e.pair,exchange:e.exchange,time:t||e.time,open:e.open,high:e.high,low:e.low,close:e.close,vbuy:e.vbuy,vsell:e.vsell,cbuy:e.cbuy,csell:e.csell,lbuy:e.lbuy,lsell:e.lsell}}renderBars(e,t,i){let s,a=!1;if(t){const e=this.getLoadedIndicator(t);"left"!==e.options.priceScaleId&&"right"!==e.options.priceScaleId||(a=!0),s=[...this.getReferencedIndicators(e),t]}this.clearPriceLines(s);const n={};let r,o,c=null,l=null;if(e.length){if(this.activeRenderer&&this.activeRenderer.timestamp>e[e.length-1].time){const t=Object.values(this.activeRenderer.sources).filter(e=>!1===e.empty);for(let i=0;i<t.length;i++){const s=t[i];s.time=this.activeRenderer.timestamp;for(let a=e.length-1;a>=0;a--){const n=e[a];if(n.time<this.activeRenderer.timestamp){e.splice(a+1,0,s),t.splice(i,1),i--;break}if(n.exchange===s.exchange&&n.pair===s.pair){n.vbuy+=s.vbuy,n.vsell+=s.vsell,n.cbuy+=s.cbuy,n.csell+=s.csell,n.lbuy+=s.lbuy,n.lsell+=s.lsell,n.open=s.open,n.high=s.high,n.low=s.low,n.close=s.close,t.splice(i,1),i--;break}}}}}else if(this.activeRenderer&&this.activeRenderer.bar&&!this.activeRenderer.bar.empty&&(e=Object.values(this.activeRenderer.sources).filter(e=>!1===e.empty)),!e.length)return;let h=0;for(let d=0;d<=e.length;d++){const i=e[d];if(!i||!r||i.time>r.timestamp){if(r){if(r.bar.empty&&!this.fillGapsWithEmpty&&i){this.nextBar(i.time,r);continue}null===c&&(c=r.timestamp),l=r.timestamp,o=this.computeBar(r,s);for(const e in o)!a&&s&&t!==e&&-1!==s.indexOf(e)||("undefined"===typeof n[e]&&(n[e]=[]),n[e].push(o[e]))}if(!i)break;if(h++,r){if(this.fillGapsWithEmpty&&"time"===r.type){const e=(i.time-r.timeframe-r.timestamp)/r.timeframe;if(e>0)for(let i=0;i<e;i++){this.incrementRendererBar(r);for(const e in o)!a&&s&&t!==e&&-1!==s.indexOf(e)||("undefined"===typeof n[e]&&(n[e]=[]),n[e].push({time:r.localTimestamp}))}}this.nextBar(i.time,r)}else r=this.createRenderer(i.time||this.activeRenderer.timestamp,s)}const p=i.exchange+":"+i.pair,u=this.marketsFilters[p];u&&!i.empty&&(r.bar.empty=!1,r.bar.vbuy+=i.vbuy,r.bar.vsell+=i.vsell,r.bar.cbuy+=i.cbuy,r.bar.csell+=i.csell,r.bar.lbuy+=i.lbuy,r.bar.lsell+=i.lsell),r.sources[p]=this.cloneSourceBar(i),r.sources[p].empty=!1,r.sources[p].active=u}if(this.activeRenderer){this.activeRenderer.bar=r.bar;for(const e in r.indicators)this.activeRenderer.indicators[e]=r.indicators[e];for(const e in r.sources)this.activeRenderer.sources[e]=r.sources[e]}else this.activeRenderer=r;this.replaceData(n,i),setTimeout(this.renderAlerts.bind(this)),s&&s.length||(this.activeRenderer.length=h,e.length?(this.renderedRange.from=c,this.renderedRange.to=l):this.renderedRange.from=this.renderedRange.to=null)}removeIndicatorSeries(e){if(this.chartInstance)for(let i=0;i<e.apis.length;i++)this.chartInstance.removeSeries(e.apis[i]),e.apis.splice(i--,1);this.unbindIndicator(e,this.activeRenderer);const t="undefined"===typeof this.loadedIndicators.find(t=>t.id!==e.id&&!1!==t.options.visible&&t.options.priceScaleId===e.options.priceScaleId);t&&this.priceScales.splice(this.priceScales.indexOf(e.options.priceScaleId),1)}createIndicatorSeries(e){const t=[],i=o["b"].state[this.paneId].priceScales[e.options.priceScaleId];i&&i.priceFormat&&(e.options.priceFormat={...e.options.priceFormat,...i.priceFormat});for(let s=0;s<e.model.plots.length;s++){const i=e.model.plots[s],a=Object(l["c"])("add-"+i.type+"-series"),n=this.serieBuilder.getCustomPlotOptions(e,i),r={...m["c"],...m["b"][i.type]||{},...e.options,...n};r.scaleMargins&&delete r.scaleMargins;const o=this.chartInstance[a](r);o.id=i.id,this.seriesIndicatorsMap[i.id]={indicatorId:e.id,plotIndex:s},t.push(i.id),e.apis.push(o)}o["b"].commit(this.paneId+"/SET_INDICATOR_SERIES",{id:e.id,series:t}),this.ensurePriceScale(e.options.priceScaleId,e),this.bindIndicator(e,this.activeRenderer)}refreshPriceScale(e){const t=o["b"].state[this.paneId].priceScales[e];this.chartInstance.priceScale(e).applyOptions({scaleMargins:t.scaleMargins,mode:t.mode})}preventPan(){if(this.panPrevented)return;const e=100;"undefined"!==typeof this._releasePanTimeout&&clearTimeout(this._releasePanTimeout),this.panPrevented=!0,this._releasePanTimeout=window.setTimeout(()=>{this.panPrevented=!1},e)}renderAll(e){if(!this.chartInstance)return;if(this._promiseOfMarkets)return this._promiseOfMarketsRender||(this._promiseOfMarketsRender=this._promiseOfMarkets.then(()=>{this._promiseOfMarketsRender=null,this.renderAll(!0)})),this._promiseOfMarketsRender;const t=this.chartInstance.timeScale().scrollPosition();this.clearChart(e),this.renderBars(this.chartCache.chunks.length?this.chartCache.chunks.reduce((e,t)=>e.concat(t.bars),[]):[],null,!e),t&&this.chartInstance.timeScale().scrollToPosition(t,!1)}async renderAlerts(){if(this._alertsRendered||!o["b"].state.settings.alerts||!o["b"].state[this.paneId].showAlerts)return;const e=this.getPriceApi();if(e){for(const t of this.marketsIndexes){const i=await y["b"].getAlerts(t);for(let t=0;t<i.length;t++)this.renderAlert(i[t],e)}this._alertsRendered=!0}}onAlert({timestamp:e,price:t,market:i,type:s,newPrice:a}){if(-1===this.marketsIndexes.indexOf(i))return;const n=y["b"].alerts[i].find(e=>e.price===t),r=this.getPriceApi();if(!r)return;const c=this.chartInstance.timeScale();let l;c&&e&&(l=c.coordinateToLogical(c.timeToCoordinate(e)));const h=r.getPriceLine(a||t,l);switch(s){case y["a"].DELETED:h&&r.removePriceLine(h);break;case y["a"].UPDATED:h&&r.removePriceLine(h),this.renderAlert({...n,price:a},r);break;case y["a"].TRIGGERED:o["b"].state.settings.alertSound&&I["d"].playOnce(o["b"].state.settings.alertSound),h&&r.removePriceLine(h),this.renderAlert(n,r);break;case y["a"].CREATED:h&&r.removePriceLine(h),this.renderAlert({timestamp:e,price:t,market:i},r,.5);break;case y["a"].ACTIVATED:h&&r.removePriceLine(h),this.renderAlert(n,r);break;case y["a"].DEACTIVATED:h&&r.removePriceLine(h),this.renderAlert(n,r,.5);break}}renderAlert(e,t,i){if(!t)return;let s;if(e.timestamp){const t=Object(l["i"])(e.timestamp,this.timeframe);s=this.chartInstance.timeScale().coordinateToLogical(this.chartInstance.timeScale().timeToCoordinate(t))}const a=o["b"].state[this.paneId].showAlertsLabel;let n="";a&&e.message&&e.message.length<3&&(n=e.message);let r=o["b"].state.settings.alertsColor;if(e.triggered&&(n+="✔"),i||e.triggered){const e=Object(d["l"])(r);e[3]=(e[3]||1)*(i||.5),r=Object(d["j"])(e)}return t.createPriceLine({market:e.market,message:e.message,index:s,price:e.price,lineWidth:o["b"].state.settings.alertsLineWidth,lineStyle:o["b"].state.settings.alertsLineStyle,color:r,title:n.length?n:null,axisLabelVisible:a})}replaceData(e,t){t&&this.preventPan();for(let s=this.loadedIndicators.length-1;s>=0;s--)if(!1!==this.loadedIndicators[s].options.visible)for(let t=0;t<this.loadedIndicators[s].apis.length;t++){const a=this.loadedIndicators[s].apis[t].id;if(e[a])try{this.loadedIndicators[s].apis[t].setData(e[a])}catch(i){o["b"].commit(this.paneId+"/SET_INDICATOR_ERROR",{id:this.loadedIndicators[s].id,error:i.message}),this.setIndicatorOption(this.loadedIndicators[s].id,"visible",!1)}}}updateBar(e){this.preventPan();const t=[];for(let i=0;i<this.loadedIndicators.length;i++){if(!1===this.loadedIndicators[i].options.visible)continue;const s=this.loadedIndicators[i],a=e.indicators[s.id];if(this.loadedIndicators[i].adapter(e,a.functions,a.variables,s.apis,s.options,$),a.canRender)for(let e=0;e<s.apis.length;e++)if(a.series[e]&&!a.series[e].rendered){if("line"===s.model.plots[e].type&&!a.series[e].value||"histogram"===s.model.plots[e].type&&!a.series[e].value||("cloudarea"===s.model.plots[e].type||"brokenarea"===s.model.plots[e].type)&&null===a.series[e].lowerValue||"histogram"===s.model.plots[e].type&&!a.series[e].value)continue;t.push([s.apis[e],a.series[e]])}}for(let i=0;i<t.length;i++)t[i][0].update(t[i][1]),t[i][1].rendered=!0}computeBar(e,t){const i={};for(let a=0;a<this.loadedIndicators.length;a++){if(t&&-1===t.indexOf(this.loadedIndicators[a].id)||!1===this.loadedIndicators[a].options.visible)continue;const n=this.loadedIndicators[a],r=e.indicators[n.id];r.series=[];try{n.adapter(e,r.functions,r.variables,n.apis,n.options,$)}catch(s){o["b"].commit(this.paneId+"/SET_INDICATOR_ERROR",{id:n.id,error:s.message});continue}for(let t=0;t<r.series.length;t++){if(!n.model.plots[t])break;e.length<r.minLength||!r.series[t]||"undefined"!==typeof r.series[t].value&&null===r.series[t].value||"undefined"!==typeof r.series[t].lowerValue&&null===r.series[t].lowerValue||"histogram"===n.model.plots[t].type&&0===r.series[t].value||(i[n.apis[t].id]=r.series[t])}}return i}getPriceApi(){if(this._priceApi)return this._priceApi;const e=this.loadedIndicators.find(e=>"price"===e.id);if(e&&!1!==e.options.visible)return this._priceIndicatorId="price",this._priceApi=e.apis[0],this._priceApi;for(let t=0;t<this.loadedIndicators.length;t++)for(let e=0;e<this.loadedIndicators[t].apis.length;e++){const i=this.loadedIndicators[t].apis[e];if("right"===i.options().priceScaleId)return this._priceIndicatorId=this.loadedIndicators[t].id,this._priceApi=i,this._priceApi}}createRenderer(e,t){e=Object(l["i"])(e,this.timeframe);const i={timestamp:e,localTimestamp:e+this.timezoneOffset,timeframe:this.timeframe,type:this.type,length:1,indicators:{},sources:{},bar:{vbuy:0,vsell:0,cbuy:0,csell:0,lbuy:0,lsell:0,empty:!0}};this.loadedIndicators=this.loadedIndicators.sort((e,t)=>{const i=e.model?e.model.references.length:0,s=t.model?t.model.references.length:0;return i-s});for(const s of this.loadedIndicators)t&&-1===t.indexOf(s.id)||!1===s.options.visible||this.bindIndicator(s,i);return i}nextBar(e,t){if(this.fillGapsWithEmpty&&t===this.activeRenderer&&"time"===this.activeRenderer.type&&this.activeRenderer.timestamp<e-this.activeRenderer.timeframe){const i=(e-this.activeRenderer.timeframe-this.activeRenderer.timestamp)/this.activeRenderer.timeframe;for(let e=0;e<this.loadedIndicators.length;e++)for(let s=0;s<this.loadedIndicators[e].apis.length;s++)for(let a=0;a<i;a++)0===e&&0===s&&this.incrementRendererBar(t),this.loadedIndicators[e].apis[s].update({time:t.localTimestamp})}this.incrementRendererBar(t),this.resetRendererBar(t),t.timestamp=e,t.localTimestamp=e+this.timezoneOffset}incrementRendererBar(e){e.length++,e.timestamp+=e.timeframe,e.localTimestamp+=e.timeframe,e.price=null;for(let t=0;t<this.loadedIndicators.length;t++){const i=e.indicators[this.loadedIndicators[t].id];if(i){i.canRender=e.length>=i.minLength;for(let e=0;e<i.functions.length;e++){const t=i.functions[e];"function"===typeof $[t.name].next&&$[t.name].next(t)}for(let e=0;e<i.variables.length;e++){const t=i.variables[e];t.length>1&&(t.state.unshift(t.state[0]),t.state.length>t.length&&t.state.pop())}}}}resetRendererBar(e){if(e.bar={vbuy:0,vsell:0,cbuy:0,csell:0,lbuy:0,lsell:0,empty:!0},"undefined"!==typeof e.sources)for(const t in e.sources)this.resetBar(e.sources[t])}resetBar(e){return null!==e.close&&(e.open=e.close,e.high=e.close,e.low=e.close),e.vbuy=0,e.vsell=0,e.cbuy=0,e.csell=0,e.lbuy=0,e.lsell=0,e.empty=!0,e}prepareRendererForIndicators(e,t){let i=Object.keys(e.model.markets);e.model.sources.length&&(i=Object.keys(this.marketsFilters).concat(i).filter((e,t,i)=>i.indexOf(e)===t));for(let s=0;s<i.length;s++){t.sources[i[s]]||(t.sources[i[s]]={open:null,high:null,low:null,close:null});let a=e.model.markets[i[s]]||[];if(e.model.sources.length&&(a=e.model.sources.map(e=>e.prop).concat(a).filter((e,t,i)=>i.indexOf(e)===t)),a.length)for(let e=0;e<a.length;e++)"undefined"===typeof t.sources[i[s]][a[e]]&&"open"!==a[e]&&"high"!==a[e]&&"low"!==a[e]&&"close"!==a[e]&&(t.sources[i[s]][a[e]]=0)}}toggleFillGapsWithEmpty(){this.fillGapsWithEmpty=!this.fillGapsWithEmpty,this.renderAll()}refreshAutoDecimals(e,t){if(e&&-1===e.indexOf(this.mainIndex))return;const i=v["l"][this.mainIndex];for(let s=0;s<this.loadedIndicators.length;s++){if(t&&t!==this.loadedIndicators[s].id)continue;let e=this.loadedIndicators[s].options.priceFormat||{type:"price"};const a="number"===typeof i?i:"number"===typeof e.precision?e.precision:2;if(!e.auto||"volume"===e.type||e.precision===a)continue;const n={precision:a,minMove:1/Math.pow(10,a)};e={...e,...n,auto:!0},o["b"].dispatch(this.paneId+"/setIndicatorOption",{id:this.loadedIndicators[s].id,key:"priceFormat",value:e,silent:!0});const r=o["b"].state[this.paneId].priceScales[this.loadedIndicators[s].options.priceScaleId];o["b"].commit(this.paneId+"/SET_PRICE_SCALE",{id:this.loadedIndicators[s].options.priceScaleId,priceScale:{...r,priceFormat:n}});for(let t=0;t<this.loadedIndicators[s].apis.length;t++)this.loadedIndicators[s].apis[t].applyOptions({priceFormat:n})}}async screenshotIndicator(e){const t=this.getLoadedIndicator(e),i={width:this.chartElement.clientWidth,height:this.chartElement.clientHeight},s=this.chartInstance.timeScale(),a=s.scrollPosition(),n=s.options(),r=this.chartInstance.options(),c=this.chartInstance.priceScale(t.options.priceScaleId),h=this.chartInstance.priceScale("left"),d=this.chartInstance.priceScale("right"),p=h.options().visible,u=d.options().visible,{top:m,bottom:g}=c.options().scaleMargins,f=r.watermark.visible,b={visible:n.visible,barSpacing:n.barSpacing,rightOffset:n.rightOffset};let v;this.chartInstance.resize(420,180),this.chartInstance.applyOptions({watermark:{visible:!1}}),c.applyOptions({scaleMargins:{top:0,bottom:0}}),s.applyOptions({visible:!1,barSpacing:3,rightOffset:0}),h.applyOptions({visible:!1}),d.applyOptions({visible:!1});try{this.clearQueue(),this.clearChart(),this.redrawIndicator(t.id,this.chartCache.cacheRange.to-400*this.timeframe),await Object(l["y"])(1),v=this.chartInstance.takeScreenshot()}catch(I){}if(this.renderAll(),this.setupQueue(),this.chartInstance.resize(i.width,i.height),c.applyOptions({scaleMargins:{top:m,bottom:g}}),h.applyOptions({visible:p}),d.applyOptions({visible:u}),s.applyOptions({...b,barSpacing:o["b"].state[this.paneId].barSpacing}),this.chartInstance.applyOptions({watermark:{visible:f}}),s.scrollToPosition(a,!1),v)return new Promise(e=>{v.toBlob(t=>{e(t)})})}getPrice(){return this.activeRenderer?(this.activeRenderer.price||(this.activeRenderer.price=+$.avg_close.update({},this.activeRenderer).toFixed(8)),this.activeRenderer.price):null}getChartCanvas(){return this.chartElement.querySelector("tr:first-child td:nth-child(2) canvas:nth-child(2)")}flipChart(){const e=this.getPriceApi(),t=e.priceScale(),i=t.options().invertScale;e.priceScale().applyOptions({invertScale:!i})}takeScreenshot(e){const t=this.chartInstance.takeScreenshot(),i=document.createElement("canvas"),s=i.getContext("2d"),a=o["b"].state.panes.panes[this.paneId].zoom||1,n=window.devicePixelRatio||1,r=16*a*n,c=12*a*n;i.width=t.width,s.font=c+"px Share Tech Mono",s.textAlign="left",s.textBaseline="top";const h=[],[p,u]=(new Date).toISOString().split("T");h.push(p+" "+u.split(".")[0]+" UTC"),h.push(this.watermark+" | "+Object(l["q"])(o["b"].state[this.paneId].timeframe));const m=Math.round(c);i.height=t.height;const g=getComputedStyle(document.documentElement),f=g.getPropertyValue("--theme-base"),b=g.getPropertyValue("--theme-color-base"),v=o["b"].state.settings.backgroundColor;e.shiftKey||(s.fillStyle=f,s.fillRect(0,0,i.width,i.height),s.fillStyle=v,s.fillRect(0,0,i.width,i.height)),s.fillStyle="light"===o["b"].state.settings.theme?"rgba(255,255,255,.2)":"rgba(0,0,0,.2)",s.fillRect(0,0,i.width,i.height),s.drawImage(t,0,0),s.fillStyle=b,s.font=c+"px Share Tech Mono",s.textAlign="left",s.textBaseline="top";let I=0;for(let o=0;o<h.length;o++)s.strokeStyle=f,s.lineWidth=4*n,s.lineJoin="round",s.strokeText(h[o],r,r+I),s.fillText(h[o],r,r+I),I+=1.2*m*(o+1);I+=2*r,o["b"].state[this.paneId].showIndicators&&Object.values(o["b"].state[this.paneId].indicators).forEach(e=>{const t=e.options;if(!1===t.visible)return;let i=t.color||t.upColor||b;try{i=Object(d["l"])(i),"undefined"!==typeof i[3]&&(i[3]=1),i=Object(d["j"])(i)}catch(o){}const a=e.displayName||e.name;s.fillStyle=b,s.strokeStyle=f,s.lineWidth=4*n,s.fillStyle=i,s.lineJoin="round",s.strokeText(a,r,I),s.fillText(a,r,I),I+=1.2*m});const y=i.toDataURL("image/png"),w=y.indexOf("base64,")+7,_=y.substr(w);Object(l["u"])(_,"image/png")}restart(){this.destroy(),this.initialize()}fetch(e){e||(this.hasReachedEnd=!1);const t=this.chartCache.cacheRange&&this.chartCache.cacheRange.from,i=k.filterOutUnavailableMarkets(o["b"].state.panes.panes[this.paneId].markets);if(!i.length)return;const s=+o["b"].state[this.paneId].timeframe;if(!s)return void(this.hasReachedEnd=!0);if(-1===o["b"].state.app.apiSupportedTimeframes.indexOf(s.toString()))return;const a=this.getVisibleRange();let n;if(e)n=e;else{let e;e=t?this.chartCache.cacheRange.from:a&&a.from?a.from+o["b"].state.settings.timezoneOffset/1e3:Date.now()/1e3,n={from:e-20*s,to:e}}n.from=Object(l["i"])(Math.round(n.from),s),n.to=Object(l["i"])(Math.round(n.to),s)+s,this.chartCache.cacheRange.from&&(n.to=Math.min(Object(l["i"])(this.chartCache.cacheRange.from,s),n.to));const r=Math.floor((n.to-n.from)/s),c=112,h=Object(l["j"])(r*i.length*c);return o["b"].dispatch("app/showNotice",{id:"fetching-"+this.paneId,timeout:15e3,title:`Fetching ${r*i.length} bars (~${h})`,type:"info"}),this.isLoading=!0,k.fetch(1e3*n.from,1e3*n.to,s,i).then(e=>this.onHistorical(e)).catch(e=>{this.hasReachedEnd=!0}).then(()=>{o["b"].dispatch("app/hideNotice","fetching-"+this.paneId),setTimeout(()=>{this.isLoading=!1,this.fetchMore(this.chartInstance.timeScale().getVisibleLogicalRange())},200)})}onHistorical(e){const t={from:e.from,to:e.to,bars:e.data};this.chartCache.saveChunk(t),this.renderAll(!0)}async fetchMore(e){if(this.isLoading||this.hasReachedEnd||!e||e.from>0)return;let t=0;if(this.activeRenderer)for(const a in this.activeRenderer.indicators)this.activeRenderer.indicators[a].minLength&&(t=Math.max(t,this.activeRenderer.indicators[a].minLength));const i=Math.round(Math.min(Math.abs(e.from)+t,500))+1;if(!i)return;const s={from:this.chartCache.cacheRange.from-i*o["b"].state[this.paneId].timeframe,to:this.chartCache.cacheRange.from-1};await this.fetch(s)}savePosition(e){o["b"].commit(this.paneId+"/SET_BAR_SPACING",this.getBarSpacing(e))}getBarSpacing(e){if(!e)return m["a"].timeScale.barSpacing;const t=this.getChartCanvas().clientWidth,i=t/(e.to-e.from);return i}trimChart(){if(Date.now()>this._timeToRecycle){const e=this.getVisibleRange();let t;e&&(t=e.from-2*(e.to-e.from)),this.chartCache.trim(t)&&this.renderAll(),this.setTimeToRecycle()}this._recycleTimeout=setTimeout(this.trimChart.bind(this),9e5)}setupRecycle(){this._recycleTimeout=setTimeout(this.trimChart.bind(this),18e4),this.setTimeToRecycle()}clearRecycle(){clearTimeout(this._recycleTimeout)}setTimeToRecycle(){const e=Date.now();if("time"===this.type){const t=this.getChartCanvas(),i=t.clientWidth,s=this.getBarSpacing(this.chartInstance.timeScale().getVisibleLogicalRange());this._timeToRecycle=e+Math.min(864e5,1e3*this.timeframe*(i/s)/2)}this._timeToRecycle=e+9e5}async createAlertAtPrice(e,t){if(!o["b"].state.settings.alerts){if(!await g["a"].confirm({title:"Alerts are disabled",message:"Enable alerts ?",ok:"Yes please"}))return;o["b"].commit("settings/TOGGLE_ALERTS",!0)}const i=this.mainIndex,s={price:e,market:i,timestamp:t,active:!1};y["b"].createAlert(s,this.getPrice())}async refreshChartDimensions(){if(!this.chartInstance)return;await Object(l["y"])(10);let e=0;o["b"].state.settings.autoHideHeaders||(e=2*(o["b"].state.panes.panes[this.paneId].zoom||1)*16);const t=this.chartElement.parentElement;this.chartInstance.resize(t.clientWidth,t.clientHeight-e)}async saveIndicatorPreview(e){const t=await this.screenshotIndicator(e);b["a"].saveIndicatorPreview(e,t)}toggleTimeframeDropdown(e){return this.chartControl.toggleTimeframeDropdown(e)}}var V=i("024c"),U=i("8c91"),K=function(){var e=this,t=e._self._c;e._self._setupProxy;return t("div",{staticClass:"chart-layout",style:{left:e.axis.left+"px",right:e.axis.right+"px",bottom:e.axis.time+"px"},on:{dblclick:e.close}},[t("div",{staticClass:"chart-layout__controls"},[t("button",{directives:[{name:"tippy",rawName:"v-tippy",value:{placement:"bottom",boundary:"window"},expression:"{ placement: 'bottom', boundary: 'window' }"}],staticClass:"btn -text",attrs:{title:"Revert back to original positions"},on:{click:e.cancel}},[t("i",{staticClass:"icon-eraser"})]),t("button",{directives:[{name:"tippy",rawName:"v-tippy",value:{placement:"bottom",boundary:"window"},expression:"{ placement: 'bottom', boundary: 'window' }"}],staticClass:"btn -text",attrs:{title:"Save positions"},on:{click:e.close}},[t("i",{staticClass:"icon-check"})])]),e._l(e.activePriceScales,(function(i,s){return t("chart-price-scale",{key:s,staticClass:"chart-layout__item",attrs:{paneId:e.paneId,priceScaleId:s,priceScale:i},on:{update:function(t){return e.updatePriceScaleScaleMargins(s,t)}}})}))],2)},Z=[],Q=function(){var e=this,t=e._self._c;e._self._setupProxy;return t("div",{directives:[{name:"tippy",rawName:"v-tippy",value:{followCursor:!0},expression:"{ followCursor: true }"}],staticClass:"chart-pricescale",class:{"-active":!!e.currentSide},style:{top:e.roundedTop+"%",bottom:e.roundedBottom+"%"},attrs:{title:`<code>${e.priceScale.scaleMargins.top}</code><br><code>${e.priceScale.scaleMargins.bottom}</code>`}},[t("div",{staticClass:"chart-pricescale__content"},[t("div",{staticClass:"chart-pricescale__title pane-overlay",on:{mousedown:e.handleMove,touchstart:e.handleMove}},[t("i",{staticClass:"icon-move mr8"}),t("code",[e._v(e._s(e.priceScale.indicators.join(", ")))]),"left"===e.priceScaleId||"right"===e.priceScaleId?t("code",{directives:[{name:"tippy",rawName:"v-tippy"}],staticClass:"ml4",attrs:{title:`using ${e.priceScaleId} scale`}},[e._v(" "+e._s("left"===e.priceScaleId?"← LEFT":"→ RIGHT")+" ")]):e._e(),t("dropdown-button",{staticClass:"chart-pricescale__mode -small ml8 text-bold",attrs:{options:e.modes,placeholder:"linear","button-class":"badge -outline"},on:{input:function(t){return e.updateMode(t)}},model:{value:e.priceScale.mode,callback:function(t){e.$set(e.priceScale,"mode",t)},expression:"priceScale.mode"}})],1),t("div",{staticClass:"chart-pricescale__size pane-overlay",domProps:{textContent:e._s(100-e.roundedTop-e.roundedBottom+"%")}})]),t("div",{staticClass:"chart-pricescale__boundary -top",class:{"-active":"top"===e.currentSide},on:{mousedown:function(t){return e.handleResize(t,"top")},touchstart:function(t){return e.handleResize(t,"top")}}}),t("div",{staticClass:"chart-pricescale__boundary -bottom",class:{"-active":"bottom"===e.currentSide},on:{mousedown:function(t){return e.handleResize(t,"bottom")},touchstart:function(t){return e.handleResize(t,"bottom")}}})])},J=[],Y=i("3918");let X=class extends r["c"]{constructor(){super(...arguments),this.top=null,this.bottom=null,this.roundedTop=null,this.roundedBottom=null,this.currentMoveId=null,this.currentSide=null,this.currentOrigin=null,this.currentContainerHeight=null,this.modes={0:"Linear",1:"Logarithimic",2:"Percent",3:"Indexed to 100"}}created(){this.getSize()}beforeDestroy(){this.release()}getSize(){this.roundedTop=this.top=100*this.priceScale.scaleMargins.top,this.roundedBottom=this.bottom=100*this.priceScale.scaleMargins.bottom}handleResize(e,t){this.currentMoveId?this.release():(this.start(t,Object(l["n"])(e).y),document.addEventListener("mousemove",this.resize),document.addEventListener("mouseup",this.release),document.addEventListener("touchmove",this.resize),document.addEventListener("touchend",this.release))}resize(e){const t=this.getPercentMove(e);t&&(this[this.currentSide]+=t*("top"===this.currentSide?1:-1),this.updateScaleMargins(e))}handleMove(e){this.currentMoveId?this.release():(this.start("both",Object(l["n"])(e).y),document.addEventListener("mousemove",this.move),document.addEventListener("mouseup",this.release),document.addEventListener("touchmove",this.move),document.addEventListener("touchend",this.release))}move(e){const t=this.getPercentMove(e);t&&(this.top+=t,this.bottom-=t,this.updateScaleMargins(e))}release(){this.currentSide&&("both"!==this.currentSide?(document.removeEventListener("mousemove",this.resize),document.removeEventListener("touchmove",this.resize)):(document.removeEventListener("mousemove",this.move),document.removeEventListener("touchmove",this.move)),document.removeEventListener("mouseup",this.release),document.removeEventListener("touchend",this.release),this.currentMoveId=null,this.currentSide=null,this.top=this.roundedTop,this.bottom=this.roundedBottom)}updateScaleMargins(e){const t=Math.round(this.top),i=Math.round(this.bottom);this.roundedTop=Math.max(0,Math.min(100-i,t)),this.roundedBottom=Math.max(0,Math.min(i,100-t));const s={top:this.roundedTop/100,bottom:this.roundedBottom/100};this.priceScale.scaleMargins.top===s.top&&this.priceScale.scaleMargins.bottom===s.bottom||this.$emit("update",{id:this.currentMoveId,side:this.currentSide,value:s,syncable:"touchmove"!==e.type&&!e.shiftKey})}updateMode(e){this.priceScale.mode=+e,this.$store.commit(this.paneId+"/SET_PRICE_SCALE",{id:this.priceScaleId,priceScale:this.priceScale})}getContainerHeight(){const e=parseFloat(this.$el.parentElement.clientHeight);return e}getPercentMove(e){const t=Object(l["n"])(e),i=(t.y-this.currentOrigin)/this.currentContainerHeight*100;return i?(this.currentOrigin=t.y,i):null}start(e,t){this.currentMoveId=Object(l["x"])(8),this.currentSide=e,this.currentOrigin=t,this.currentContainerHeight=this.getContainerHeight()}};X=Object(n["a"])([Object(r["a"])({name:"ChartPriceScale",components:{DropdownButton:Y["a"]},props:{paneId:{required:!0},priceScaleId:{required:!0},priceScale:{required:!0}},watch:{"priceScale.scaleMargins.top":function(){this.currentMoveId||this.getSize()},"priceScale.scaleMargins.bottom":function(){this.currentMoveId||this.getSize()}}})],X);var ee=X,te=ee,ie=(i("3285"),i("2877")),se=Object(ie["a"])(te,Q,J,!1,null,null,null),ae=se.exports;let ne=class extends r["c"]{created(){this.getActivePriceScales()}mounted(){document.body.classList.add("-unselectable"),this.bindEscKey()}beforeDestroy(){document.body.classList.remove("-unselectable"),this._handleEscKey&&document.removeEventListener("keydown",this._handleEscKey)}getActivePriceScales(){const e=this.$store.state[this.paneId].indicators;this.activePriceScales=Object.keys(e).reduce((t,i)=>{if("string"===typeof this.layouting&&i!==this.layouting)return t;const s=e[i].options.priceScaleId;return t[s]||(t[s]=this.$store.state[this.paneId].priceScales[s],t[s].indicators=[]),t[s].indicators.push(e[i].name),t},{}),this._originalActivePriceScales=JSON.parse(JSON.stringify(this.activePriceScales))}updatePriceScaleScaleMargins(e,t){t.syncable&&this.unsyncableMoveId!==t.id&&(this.syncMoveWithOthers(e,t.side,t.value)||(this.unsyncableMoveId=t.id)),this.activePriceScales[e].scaleMargins=t.value,this.$store.commit(this.paneId+"/SET_PRICE_SCALE",{id:e,priceScale:this.activePriceScales[e]})}syncMoveWithOthers(e,t,i){const s=this.activePriceScales[e].scaleMargins;let a=!1;for(const n in this.activePriceScales){if(e===n)continue;const t=this.activePriceScales[n].scaleMargins;t.top===s.top&&t.bottom===s.bottom&&(r["c"].set(this.activePriceScales[n],"scaleMargins",i),this.$store.commit(this.paneId+"/SET_PRICE_SCALE",{id:n,priceScale:this.activePriceScales[n]}),a=!0)}return a}cancel(){for(const e in this._originalActivePriceScales)this.$store.commit(this.paneId+"/SET_PRICE_SCALE",{id:e,priceScale:this._originalActivePriceScales[e]});this.$store.commit(this.paneId+"/TOGGLE_LAYOUTING")}close(){this.$store.commit(this.paneId+"/TOGGLE_LAYOUTING")}bindEscKey(){this._handleEscKey||(this._handleEscKey=e=>{"Escape"===e.key&&this.close()},document.addEventListener("keydown",this._handleEscKey))}};ne=Object(n["a"])([Object(r["a"])({components:{ChartPriceScale:ae},name:"ChartLayout",props:{paneId:{required:!0},axis:{required:!0},layouting:{required:!0}}})],ne);var re=ne,oe=re,ce=(i("9fed"),Object(ie["a"])(oe,K,Z,!1,null,null,null)),le=ce.exports,he=function(){var e=this,t=e._self._c;e._self._setupProxy;return t("div",{staticClass:"chart-overlay__panel indicators-overlay"},[e.value?t("div",{staticClass:"chart-overlay__content"},[t("dropdown",{model:{value:e.dropdownTrigger,callback:function(t){e.dropdownTrigger=t},expression:"dropdownTrigger"}},[t("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:function(t){return e.editIndicator(e.selectedIndicator)}}},[t("i",{staticClass:"icon-edit"}),t("span",[e._v("Edit")])]),t("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:function(t){return e.resizeIndicator(e.selectedIndicator)}}},[t("i",{staticClass:"icon-resize-height"}),t("span",[e._v("Resize")])]),t("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:function(t){return e.duplicateIndicator(e.selectedIndicator)}}},[t("i",{staticClass:"icon-copy-paste"}),t("span",[e._v("Duplicate")])]),t("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:function(t){return e.downloadIndicator(e.selectedIndicator)}}},[t("i",{staticClass:"icon-download"}),t("span",[e._v("Download")])]),t("div",{staticClass:"dropdown-divider"}),t("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:function(t){return e.removeIndicator(e.selectedIndicator)}}},[t("i",{staticClass:"icon-trash"}),t("span",[e._v("Remove")])])]),e._l(e.indicators,(function(i,s){return t("IndicatorControl",{key:s,attrs:{"indicator-id":s,"pane-id":e.paneId},on:{action:e.onClickIndicator}})}))],2):e._e(),t("div",{staticClass:"chart-overlay__head pane-overlay",on:{click:e.toggleOverlay}},[t("span",{staticClass:"chart-overlay__title"},[e._v("Indicators")]),t("button",{staticClass:"btn badge -outline",attrs:{type:"button"},on:{click:function(t){return t.stopPropagation(),e.addIndicator.apply(null,arguments)}}},[e._v(" Add ")]),t("i",{staticClass:"icon-up-thin"})])])},de=[],pe=i("2b0e"),ue=i("2fe1"),me=function(){var e=this,t=e._self._c;e._self._setupProxy;return t("div",{staticClass:"indicator",class:{"-error":!!e.error,"-disabled":!e.visible}},[t("button",{staticClass:"indicator__name pane-overlay",attrs:{type:"button"},on:{click:e.onClick}},[e._v(" "+e._s(e.name)+" ")]),t("div",{staticClass:"indicator__controls"},[t("button",{staticClass:"btn",attrs:{title:e.visible?"Hide":"Show"},on:{click:e.toggleVisibility}},[t("i",{class:{"icon-visible":!e.visible,"icon-hidden":e.visible}})]),t("button",{staticClass:"btn",attrs:{title:"Menu"},on:{click:function(t){return e.$emit("action",{indicatorId:e.indicatorId,actionName:"menu",event:t})}}},[t("i",{staticClass:"icon-more"})])]),t("div",{staticClass:"indicator__legend pane-overlay",attrs:{id:e.paneId+e.indicator.id}}),e.error?t("div",[t("i",{staticClass:"icon-warning ml4 mr8"}),e._v(" "+e._s(e.error)+" ")]):e._e()])},ge=[];let fe=class extends pe["default"]{get indicator(){return this.$store.state[this.paneId].indicators[this.indicatorId]}get showLegend(){return this.$store.state[this.paneId].showLegend}get name(){return this.indicator.displayName?this.indicator.displayName:this.indicator.name?this.indicator.name:this.indicatorId}get visible(){return!this.indicator.options||"undefined"===typeof this.indicator.options.visible||this.indicator.options.visible}get error(){return this.$store.state[this.paneId].indicatorsErrors[this.indicatorId]}onClick(e){e.shiftKey?this.$emit("action",{actionName:"resize",indicatorId:this.indicatorId}):this.$emit("action",{indicatorId:this.indicatorId})}toggleVisibility(){this.$nextTick(()=>{this.$store.dispatch(this.paneId+"/toggleSerieVisibility",this.indicatorId)})}};fe=Object(n["a"])([Object(ue["b"])({name:"IndicatorControl",props:{paneId:{required:!0},indicatorId:{required:!0}}})],fe);var be=fe,ve=be,Ie=(i("c661"),Object(ie["a"])(ve,me,ge,!1,null,"c9f2c20c",null)),ye=Ie.exports,we=function(){var e=this,t=e._self._c;return t("Dialog",{staticClass:"indicator-library-dialog",on:{clickOutside:e.close},scopedSlots:e._u([{key:"header",fn:function(){return[t("div",{staticClass:"dialog__title"},[e._v("Add indicator")]),t("div",{staticClass:"column -center"})]},proxy:!0},{key:"footer",fn:function(){return[t("button",{staticClass:"btn -blue -large -cases -file"},[t("input",{ref:"importButton",staticClass:"input-file",attrs:{type:"file"},on:{change:e.handleFile}}),e._v(" Import "),t("i",{staticClass:"icon-upload ml8"})]),t("button",{staticClass:"mlauto btn -green -large -cases",on:{click:e.promptCreateIndicator}},[e._v(" Create new "),t("i",{staticClass:"icon-plus ml8"})])]},proxy:!0}])},[t("canvas",{ref:"preview",staticClass:"indicator-library-dialog__preview",attrs:{width:"420",height:"180"}}),t("div",{staticClass:"form-group"},[t("div",{staticClass:"d-flex mb8"},[t("input",{directives:[{name:"model",rawName:"v-model",value:e.query,expression:"query"},{name:"autofocus",rawName:"v-autofocus"}],staticClass:"form-control",attrs:{type:"text",placeholder:"search"},domProps:{value:e.query},on:{input:function(t){t.target.composing||(e.query=t.target.value)}}}),t("div",{staticClass:"-center text-muted ml16",domProps:{textContent:e._s(e.indicators.length)}})]),t("table",{staticClass:"table table--inset"},[t("thead",[t("tr",[t("th",{staticClass:"table-sortable",class:["name"===e.sortProperty&&"table-sort--active"],attrs:{width:"200px"},on:{click:function(t){return e.toggleSort("name")}}},[t("span",[e._v("Name")]),"name"===e.sortProperty?t("i",{staticClass:"table-sortable__direction icon-up",class:[e.sortDirection<0&&"table-sortable__direction--desc"]}):e._e()]),t("th",{staticClass:"indicator-library-dialog__desktop table-sortable",attrs:{width:"200px"},on:{click:function(t){return e.toggleSort("description")}}},[t("span",[e._v("Description")]),"description"===e.sortProperty?t("i",{staticClass:"table-sortable__direction icon-up",class:[e.sortDirection<0&&"table-sortable__direction--desc"]}):e._e()]),t("th",{staticClass:"indicator-library-dialog__desktop table-sortable",on:{click:function(t){return e.toggleSort("updatedAt")}}},[t("span",[e._v("Date")]),"updatedAt"===e.sortProperty?t("i",{staticClass:"table-sortable__direction icon-up",class:[e.sortDirection<0&&"table-sortable__direction--desc"]}):e._e()]),t("th")])]),e.filteredIndicators.length?t("tbody",{on:{mousemove:e.movePreview,mouseleave:e.clearPreview}},e._l(e.filteredIndicators,(function(i){return t("tr",{directives:[{name:"tippy",rawName:"v-tippy",value:{placement:"left",boundary:"window"},expression:"{ placement: 'left', boundary: 'window' }"}],key:i.id,staticClass:"-action",attrs:{title:i.id},on:{click:function(t){return e.selectIndicator(i)},mouseenter:function(t){return e.showPreview(t,i)}}},[t("td",{staticClass:"table-input text-color-base"},[e._v(" "+e._s((i.displayName||i.name).replace(/\{[\w_]+\}/g,""))+" ")]),t("td",{staticClass:"indicator-library-dialog__desktop table-input"},[t("span",{staticClass:"text-muted"},[e._v(e._s(i.description))])]),t("td",{staticClass:"indicator-library-dialog__desktop table-input",on:{click:function(t){return t.stopPropagation(),e.showIndicatorActivity(i)}}},[t("span",[e._v(e._s(e.ago(i.updatedAt)))])]),t("td",{staticClass:"table-action -hover",on:{click:function(t){return t.stopPropagation(),e.toggleDropdown(t,i)}}},[t("button",{staticClass:"btn -text -small"},[t("i",{staticClass:"icon-more"})])])])})),0):e._e()])]),t("dropdown",{model:{value:e.dropdownTrigger,callback:function(t){e.dropdownTrigger=t},expression:"dropdownTrigger"}},[t("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:function(t){return e.selectIndicator()}}},[t("i",{staticClass:"icon-plus"}),t("span",[e._v("Add to chart")])]),t("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:function(t){return e.duplicateIndicator(e.selectedIndicator)}}},[t("i",{staticClass:"icon-copy-paste"}),t("span",[e._v("Duplicate")])]),t("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:function(t){return e.downloadIndicator(e.selectedIndicator)}}},[t("i",{staticClass:"icon-download"}),t("span",[e._v("Download")])]),t("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:function(t){return e.refreshPreview(e.selectedIndicator)}}},[t("i",{staticClass:"icon-refresh"}),t("span",[e._v("Preview")])]),t("div",{staticClass:"dropdown-divider"}),t("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:function(t){return e.removeIndicator(e.selectedIndicator)}}},[t("i",{staticClass:"icon-trash"}),t("span",[e._v("Remove")])])])],1)},_e=[],Ce=i("7250"),ke=i("1ea0"),xe=i("e7a1"),Se={mixins:[ke["a"]],components:{Dialog:Ce["a"]},props:{paneId:{type:String,required:!0}},data:()=>({name:"",priceScaleId:"right",query:"",indicators:[],selectedIndicator:null,dropdownTrigger:null,sortDirection:-1,sortProperty:"updatedAt",ago:l["a"]}),computed:{queryFilter:function(){return new RegExp(this.query.replace(/\W/,".*"),"i")},sortFunction(){return"description"===this.sortProperty?this.sortDirection>0?(e,t)=>(e.description||"").localeCompare(t.description||""):(e,t)=>(t.description||"").localeCompare(e.description||""):"name"===this.sortProperty?this.sortDirection>0?(e,t)=>(e.name||"").localeCompare(t.name||""):(e,t)=>(t.name||"").localeCompare(e.name||""):"createdAt"===this.sortProperty?this.sortDirection>0?(e,t)=>e.createdAt-t.createdAt:(e,t)=>t.createdAt-e.createdAt:"updatedAt"===this.sortProperty?this.sortDirection>0?(e,t)=>e.updatedAt-t.updatedAt:(e,t)=>t.updatedAt-e.updatedAt:(e,t)=>e.id.localeCompare(t.id)},filteredIndicators(){const e=this.sortFunction;return this.indicators.filter(e=>this.queryFilter.test(e.name)||this.queryFilter.test(e.displayName)).sort(e)},availableScales(){return this.indicators.map(e=>e.options&&e.options.priceScaleId).reduce((e,t)=>(!t||e[t]||(e[t]=t),e),{"":"Own scale",right:"Main scale (right)"})}},async created(){await this.getIndicators()},mounted(){document.getElementById("app").appendChild(this.$refs.preview)},beforeDestroy(){this.editor&&this.editor.destroy(),this.$refs.preview&&this.$refs.preview.remove()},methods:{async showPreview(e,t){if(t.preview){if(t.id!==this._previewId){const e=this.$refs.preview.getContext("2d");this.clearPreview(),this._previewId=t.id,t.preview instanceof Blob&&(this._previewUrl=URL.createObjectURL(t.preview),this._previewImageHandler=()=>{e.drawImage(this._previewImageElement,0,0),URL.revokeObjectURL(this._previewUrl),this._previewImageHandler=null,this._previewImageElement=null,this._previewUrl=null},this._previewImageElement=new Image,this._previewImageElement.src=this._previewUrl,this._previewImageElement.addEventListener("load",this._previewImageHandler))}}else this.clearPreview()},movePreview(e){if(!this.$refs.preview)return;const t=Object(l["n"])(e);this.$refs.preview.style.transform=`translate(${t.x-this.$refs.preview.width/2}px, ${t.y-this.$refs.preview.height}px)`},clearPreview(){const e=this.$refs.preview.getContext("2d");e.clearRect(0,0,this.$refs.preview.width,this.$refs.preview.height),this._previewId=null,this._previewImageElement&&(this._previewImageElement.removeEventListener("load",this._previewImageHandler),this._previewImageElement.src="",this._previewImageElement=null,this._previewImageHandler=null),this._previewUrl&&(URL.revokeObjectURL(this._previewUrl),this._previewUrl=null)},async getIndicators(){const e=+new Date("2021-06-07T00:00:00Z");this.indicators=(await b["a"].getIndicators()).map(t=>({...t,updatedAt:t.updatedAt||e}))},async handleFile(e){try{const t=await xe["a"].getJSON(e.target.files[0]);if(!t.data)throw new Error("indicator is empty");if("indicator"!==t.type)throw new Error("not an indicator");this.createIndicator({name:t.name.split(":").slice(1).join(":"),script:t.data.script||"",options:t.data.options||{}})}catch(t){this.$store.dispatch("app/showNotice",{title:t.message,type:"error"})}},async createIndicator(e){if(e||(e={}),e.name?this.name=e.name:this.name||(this.name="Untitled"),e.id=this.getIndicatorId(this.name),e.name=this.name,!e.priceScaleId){const t=Object(l["z"])(e.name);e.priceScaleId=this.priceScaleId||t}this.$store.dispatch(this.paneId+"/addIndicator",e),g["a"].openIndicator(this.paneId,e.id),this.close(null)},getIndicatorId(e){return Object(l["B"])(Object(l["z"])(e),this.indicators.map(e=>e.id),null,"1")},selectIndicator(e=this.selectedIndicator){b["a"].incrementIndicatorUsage(e.id),this.$store.dispatch(this.paneId+"/addIndicator",e),this.close(null)},async removeIndicator(e=this.selectedIndicator){await g["a"].confirm(`Delete indicator "${e.name}" ?`)&&(b["a"].deleteIndicator(e.id),this.indicators.splice(this.indicators.indexOf(e),1))},async duplicateIndicator(e=this.selectedIndicator){this.$store.dispatch(this.paneId+"/duplicateIndicator",{paneId:this.paneId,indicatorId:e.id})},async refreshPreview(e=this.selectedIndicator){const t=this.$store.state[this.paneId].indicators[e.id];t||(this.$store.dispatch(this.paneId+"/addIndicator",e),await Object(l["y"])(250)),await this.$store.dispatch(this.paneId+"/saveIndicator",e.id),t||(await Object(l["y"])(250),this.$store.commit(this.paneId+"/REMOVE_INDICATOR",e.id)),await Object(l["y"])(250),this.getIndicators()},async downloadIndicator(e=this.selectedIndicator){await Object(l["g"])({type:"indicator",name:"indicator:"+e.name,data:e},"indicator_"+e.id)},toggleDropdown(e,t){!e||this.dropdownTrigger&&this.selectedIndicator===t?(this.dropdownTrigger=null,this.selectedIndicator=null):(this.dropdownTrigger=e.currentTarget,this.selectedIndicator=t)},async promptCreateIndicator(){const e=await g["a"].openAsPromise((await i.e("chunk-2d0b684e").then(i.bind(null,"1e04"))).default,{availableScales:this.availableScales});e&&this.createIndicator(e)},toggleSort(e){e===this.sortProperty&&(this.sortDirection=-1*this.sortDirection),this.sortProperty=e},showIndicatorActivity(e){let t="N/A";if(e.createdAt){const i=new Date(e.createdAt);t=i.toLocaleString().replace(", "," ")}let i="N/A";if(e.updatedAt){const t=new Date(e.updatedAt);i=t.toLocaleString().replace(", "," ")}g["a"].confirm({title:e.displayName,ok:null,cancel:null,html:!0,message:`ID <code>${e.id}</code>\n          <br>\n          <ul>\n            <li>Created at ${t}</li>\n            <br>\n            <li>Updated at ${i}</li>\n          </ul>`})}}},Oe=Se,Ee=(i("8fef"),Object(ie["a"])(Oe,we,_e,!1,null,null,null)),Re=Ee.exports;let Te=class extends pe["default"]{constructor(){super(...arguments),this.dropdownTrigger=null,this.selectedIndicator=null}get indicators(){return this.$store.state[this.paneId].indicators}get ids(){return Object.values(this.indicators).map(e=>e.id)}toggleOverlay(){this.$emit("input",!this.value)}toggleDropdown(e,t){!e||this.dropdownTrigger&&this.selectedIndicator===t?(this.dropdownTrigger=null,this.selectedIndicator=null):(this.dropdownTrigger=e.currentTarget,this.selectedIndicator=t)}async editIndicator(e){g["a"].open((await i.e("chunk-55227ac5").then(i.bind(null,"bb45"))).default,{paneId:this.paneId,indicatorId:e},"indicator"),this.dropdownTrigger=null}removeIndicator(e){this.$store.dispatch(this.paneId+"/removeIndicator",{id:e})}resizeIndicator(e){this.$store.commit(this.paneId+"/TOGGLE_LAYOUTING",e)}duplicateIndicator(e){this.$store.dispatch(this.paneId+"/duplicateIndicator",e)}downloadIndicator(e){this.$store.dispatch(this.paneId+"/downloadIndicator",e)}addIndicator(){g["a"].open(Re,{paneId:this.paneId})}onClickIndicator({indicatorId:e,actionName:t,event:i}){switch(t){case"menu":return this.toggleDropdown(i,e);case"remove":return this.removeIndicator(e);case"resize":return this.resizeIndicator(e)}return this.editIndicator(e)}};Te=Object(n["a"])([Object(ue["b"])({name:"IndicatorsOverlay",components:{IndicatorControl:ye},props:{paneId:{type:String},value:{type:Boolean,required:!0}}})],Te);var $e=Te,Ae=$e,Me=Object(ie["a"])(Ae,he,de,!1,null,null,null),Pe=Me.exports,Le=function(){var e=this,t=e._self._c;e._self._setupProxy;return t("div",{staticClass:"chart-overlay__panel markets-overlay"},[e.showOverlay?t("div",{staticClass:"chart-overlay__content pane-overlay"},[t("div",{staticClass:"column"},[t("a",{staticClass:"btn -text",attrs:{href:"javascript:void(0)"},on:{click:function(t){return e.toggleMarkets("perp")}}},[e._v("perp")]),t("a",{staticClass:"btn -text",attrs:{href:"javascript:void(0)"},on:{click:function(t){return e.toggleMarkets("spot")}}},[e._v("spot")]),t("a",{staticClass:"btn -text",attrs:{href:"javascript:void(0)"},on:{click:function(t){return e.toggleMarkets("all")}}},[e._v("all")])]),t("div",{staticClass:"mx4 mt0"},e._l(e.markets,(function(i){return t("div",{key:i,on:{click:function(t){return e.toggleMarket(t,i)}}},[t("label",{staticClass:"checkbox-control -extra-small mb4"},[t("input",{staticClass:"form-control",attrs:{type:"checkbox"},domProps:{checked:!e.hiddenMarkets[i]},on:{click:function(e){e.stopPropagation(),e.preventDefault()}}}),t("div"),t("span",[e._v(e._s(i))])])])})),0)]):e._e(),t("div",{staticClass:"chart-overlay__head pane-overlay",on:{click:function(t){e.showOverlay=!e.showOverlay}}},[t("div",{staticClass:"chart-overlay__title"},[e._v("Sources")]),t("button",{staticClass:"btn badge -outline",attrs:{type:"button"},on:{click:e.searchMarkets}},[t("span",[e._v(e._s(e.visibleMarkets)+" ")]),e._v("| "),t("span",[e._v("Add")])]),t("i",{staticClass:"icon-up-thin"})])])},De=[];let je=class extends pe["default"]{constructor(){super(...arguments),this.showOverlay=!1}get markets(){return this.$store.state.panes.panes[this.paneId].markets}get hiddenMarkets(){return this.$store.state[this.paneId].hiddenMarkets}get visibleMarkets(){return this.markets.filter(e=>!this.hiddenMarkets[e]).length}searchMarkets(e){this.$store.dispatch("app/showSearch",{paneId:this.paneId}),e.stopPropagation()}toggleMarket(e,t){this.$store.dispatch(this.paneId+"/toggleMarkets",{id:t,inverse:e.shiftKey})}toggleMarkets(e){this.$store.dispatch(this.paneId+"/toggleMarkets",{type:e})}};je=Object(n["a"])([Object(ue["b"])({name:"MarketsOverlay",props:{paneId:{type:String}}})],je);var ze=je,Ne=ze,He=(i("b162"),Object(ie["a"])(Ne,Le,De,!1,null,null,null)),Be=He.exports,Ge=i("7042"),Fe=i("017a");let qe=class extends(Object(r["b"])(V["a"])){constructor(){super(...arguments),this.axis={top:0,left:0,right:0,time:0}}get layouting(){return this.refreshAxisSize(),this.$store.state[this.paneId].layouting}get overlayLeft(){return this.axis.left}get overlayTop(){return this.axis.top}get favoriteTimeframes(){return this.$store.state.settings.favoriteTimeframes}get timeframe(){return this.$store.state[this.paneId].timeframe}get showIndicators(){return this.$store.state[this.paneId].showIndicators}set showIndicators(e){this.$store.commit(this.paneId+"/TOGGLE_INDICATORS",e)}get timeframeForHuman(){return this.timeframe?Object(l["q"])(this.timeframe):"ERR"}mounted(){this.chart=new W(this.paneId,this.$refs.chartContainer),this.bindAggregator(),this.refreshAxisSize(),this.showIndicators&&this.$parent.$el.clientHeight>420&&(this.showIndicators=!0)}destroyChart(){this.unbindAggregator(),this.chart.destroy()}beforeDestroy(){this.destroyChart()}onTrades(e){this.chart.queueTrades(e)}onAlert(e){this.chart.onAlert(e)}bindAggregator(){f["a"].on("trades",this.onTrades),f["a"].on("alert",this.onAlert)}unbindAggregator(){f["a"].off("trades",this.onTrades),f["a"].off("alert",this.onAlert)}renderChart(){this.chart.renderAll()}onResize(){this.chart&&(this.chart.refreshChartDimensions(),this.chart.updateFontSize())}async refreshAxisSize(){if(!this.$refs.chartContainer)return;await Object(l["y"])(10);const e=this.$store.state[this.paneId],t={top:0,left:0,right:0,time:0};e.showLeftScale&&(t.left=this.$refs.chartContainer.querySelector("tr:first-child td:first-child canvas").clientWidth),e.showRightScale&&(t.right=this.$refs.chartContainer.querySelector("tr:first-child td:last-child canvas").clientWidth),e.showTimeScale&&(t.time=this.$refs.chartContainer.querySelector("tr:last-child td:nth-child(2) canvas").clientHeight),this.axis=t}toggleLayout(){this.$store.commit(this.paneId+"/TOGGLE_LAYOUTING")}async toggleTimeframeDropdown(e,t){t.isLoading=!0,await this.chart.toggleTimeframeDropdown(e),t.isLoading=!1}restart(){this.chart.restart()}takeScreenshot(e){this.chart.takeScreenshot(e)}};qe=Object(n["a"])([Object(r["a"])({name:"Chart",components:{ChartLayout:le,PaneHeader:U["a"],IndicatorsOverlay:Pe,MarketsOverlay:Be,AlertsList:Ge["a"],Btn:Fe["a"]}})],qe);var We=qe,Ve=We,Ue=(i("edd8"),Object(ie["a"])(Ve,s,a,!1,null,"54f7fad8",null));t["default"]=Ue.exports},b162:function(e,t,i){"use strict";i("1748")},c661:function(e,t,i){"use strict";i("cf78")},cf78:function(e,t,i){},d884:function(e,t,i){},edd8:function(e,t,i){"use strict";i("d884")},ffb1:function(e,t,i){}}]);